{% extends 'teachers/base_teacher.html' %}
{% load static %}

{% block title %}Quiz Reports - Teacher Dashboard{% endblock %}

{% block teacher_content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2><i class="bi bi-bar-chart me-2"></i>Quiz Reports & Analytics</h2>
            <p class="text-muted">Filter and analyze quiz performance data</p>
        </div>
        <div class="col-md-4 text-end">
            <button class="btn btn-success" id="downloadPdfBtn" onclick="downloadReportPDF()">
                <i class="bi bi-download me-1"></i>Download PDF Report
            </button>
        </div>
    </div>

    <!-- Filters Card -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0"><i class="bi bi-funnel me-2"></i>Filters</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <!-- Quiz Filter -->
                <div class="col-md-3">
                    <label class="form-label">Quiz</label>
                    <select class="form-select" id="quizFilter" onchange="applyFilters()">
                        <option value="">All Quizzes</option>
                        {% for quiz in quizzes %}
                            <option value="{{ quiz.id }}">{{ quiz.title }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Subject Filter -->
                <div class="col-md-3">
                    <label class="form-label">Subject</label>
                    <select class="form-select" id="subjectFilter" onchange="applyFilters()">
                        <option value="">All Subjects</option>
                        {% for subject in subjects %}
                            <option value="{{ subject.id }}">{{ subject.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Student Filter -->
                <div class="col-md-3">
                    <label class="form-label">Student</label>
                    <select class="form-select" id="studentFilter" onchange="applyFilters()">
                        <option value="">All Students</option>
                        {% for student in students %}
                            <option value="{{ student.id }}">{{ student.first_name }} {{ student.last_name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Difficulty Filter -->
                <div class="col-md-3">
                    <label class="form-label">Difficulty</label>
                    <select class="form-select" id="difficultyFilter" onchange="applyFilters()">
                        <option value="">All Difficulties</option>
                        <option value="easy">Easy</option>
                        <option value="medium">Medium</option>
                        <option value="hard">Hard</option>
                    </select>
                </div>

                <!-- Date Range -->
                <div class="col-md-3">
                    <label class="form-label">Start Date</label>
                    <input type="date" class="form-control" id="startDate" onchange="applyFilters()">
                </div>

                <div class="col-md-3">
                    <label class="form-label">End Date</label>
                    <input type="date" class="form-control" id="endDate" onchange="applyFilters()">
                </div>

                <!-- Score Range -->
                <div class="col-md-3">
                    <label class="form-label">Min Score</label>
                    <input type="number" class="form-control" id="minScore" min="0" onchange="applyFilters()" placeholder="0">
                </div>

                <div class="col-md-3">
                    <label class="form-label">Max Score</label>
                    <input type="number" class="form-control" id="maxScore" min="0" onchange="applyFilters()" placeholder="1000">
                </div>

                <!-- Search -->
                <div class="col-md-6">
                    <label class="form-label">Search</label>
                    <input type="text" class="form-control" id="searchBox" placeholder="Search quiz title or student name..." onkeyup="applyFilters()">
                </div>

                <!-- Completion Status -->
                <div class="col-md-3">
                    <label class="form-label">Status</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="completedOnly" onchange="applyFilters()" checked>
                        <label class="form-check-label" for="completedOnly">Completed Only</label>
                    </div>
                </div>

                <!-- Reset Button -->
                <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-secondary w-100" onclick="resetFilters()">
                        <i class="bi bi-arrow-counterclockwise me-1"></i>Reset
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4" id="statsContainer">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Total Attempts</h6>
                    <h3 id="totalAttempts" class="mb-0">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Average Score</h6>
                    <h3 id="avgScore" class="mb-0">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Average Percentage</h6>
                    <h3 id="avgPercentage" class="mb-0">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Unique Students</h6>
                    <h3 id="uniqueStudents" class="mb-0">-</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="card shadow-sm">
        <div class="card-header bg-light">
            <h5 class="mb-0"><i class="bi bi-table me-2"></i>Attempt Details</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="attemptsTable">
                    <thead class="table-light">
                        <tr>
                            <th>Quiz</th>
                            <th>Student</th>
                            <th>Score</th>
                            <th>Percentage</th>
                            <th>Completed At</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">
                                <i class="bi bi-hourglass me-2"></i>Loading data...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="mt-3">
                <small class="text-muted" id="recordCount">Total records: -</small>
            </div>
        </div>
    </div>
</div>

<script>
async function applyFilters() {
    const filters = {
        quiz_id: document.getElementById('quizFilter').value,
        subject_id: document.getElementById('subjectFilter').value,
        student_id: document.getElementById('studentFilter').value,
        difficulty: document.getElementById('difficultyFilter').value,
        start_date: document.getElementById('startDate').value,
        end_date: document.getElementById('endDate').value,
        min_score: document.getElementById('minScore').value,
        max_score: document.getElementById('maxScore').value,
        search: document.getElementById('searchBox').value,
        completed_only: document.getElementById('completedOnly').checked
    };

    try {
        const response = await fetch('{% url "filter_quiz_reports" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(filters)
        });

        const data = await response.json();

        if (data.success) {
            updateStatistics(data.statistics);
            updateTable(data.attempts);
            document.getElementById('recordCount').textContent = `Total records: ${data.total_records}`;
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error applying filters');
    }
}

function updateStatistics(stats) {
    document.getElementById('totalAttempts').textContent = stats.total_attempts;
    document.getElementById('avgScore').textContent = stats.avg_score || '-';
    document.getElementById('avgPercentage').textContent = (stats.avg_percentage ? stats.avg_percentage + '%' : '-');
    document.getElementById('uniqueStudents').textContent = stats.unique_students;
}

function updateTable(attempts) {
    const tbody = document.getElementById('tableBody');
    
    if (attempts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">No data found</td></tr>';
        return;
    }

    tbody.innerHTML = attempts.map(attempt => `
        <tr>
            <td><strong>${attempt.quiz_title}</strong></td>
            <td>${attempt.student_name}</td>
            <td>${attempt.score}/${attempt.total}</td>
            <td>
                <span class="badge" style="background-color: ${attempt.percentage >= 70 ? '#28a745' : attempt.percentage >= 50 ? '#ffc107' : '#dc3545'}">
                    ${attempt.percentage}%
                </span>
            </td>
            <td><small>${attempt.completed_at}</small></td>
            <td><span class="badge bg-info">${attempt.status}</span></td>
        </tr>
    `).join('');
}

function resetFilters() {
    document.getElementById('quizFilter').value = '';
    document.getElementById('subjectFilter').value = '';
    document.getElementById('studentFilter').value = '';
    document.getElementById('difficultyFilter').value = '';
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    document.getElementById('minScore').value = '';
    document.getElementById('maxScore').value = '';
    document.getElementById('searchBox').value = '';
    document.getElementById('completedOnly').checked = true;
    applyFilters();
}

function downloadReportPDF() {
    const filters = new URLSearchParams({
        quiz_id: document.getElementById('quizFilter').value,
        subject_id: document.getElementById('subjectFilter').value,
        student_id: document.getElementById('studentFilter').value,
        difficulty: document.getElementById('difficultyFilter').value,
        start_date: document.getElementById('startDate').value,
        end_date: document.getElementById('endDate').value,
        min_score: document.getElementById('minScore').value,
        max_score: document.getElementById('maxScore').value,
        completed_only: document.getElementById('completedOnly').checked
    });

    window.location.href = `{% url 'download_quiz_report_pdf' %}?${filters.toString()}`;
}

// Load initial data
applyFilters();
</script>

<style>
.card {
    border: none;
    border-radius: 12px;
}

.card-header {
    border-radius: 12px 12px 0 0 !important;
    border: none;
}

.table-hover tbody tr:hover {
    background-color: #f8f9fa !important;
}

.badge {
    font-weight: 600;
    padding: 0.5rem 0.75rem;
}
</style>
{% endblock %}
