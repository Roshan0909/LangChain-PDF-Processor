{% extends 'teachers/base_teacher.html' %}
{% load static %}

{% block title %}Quiz Reports - Teacher Dashboard{% endblock %}

{% block teacher_content %}
<style>
    .reports-header {
        background: linear-gradient(135deg, #06B6D4 0%, #0891b2 100%);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 0.75rem;
        margin-bottom: 1.25rem;
        box-shadow: 0 2px 8px rgba(6, 182, 212, 0.2);
    }
    .reports-header h2 {
        margin: 0 0 0.2rem 0;
        font-weight: 700;
        font-size: 1.25rem;
    }
    .reports-header p {
        margin: 0;
        opacity: 0.9;
        font-size: 0.85rem;
    }
    .filter-card {
        border: 0;
        border-radius: 0.75rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border-left: 3px solid #06B6D4;
    }
    .filter-card .card-header {
        background: linear-gradient(135deg, #f0fbff 0%, #e0f7fb 100%);
        border: 0;
        border-radius: 0.75rem 0.75rem 0 0;
        padding: 0.7rem 1rem;
    }
    .filter-card .card-header h5 {
        color: #0891b2;
        font-weight: 700;
        font-size: 0.9rem;
    }
    .filter-card .card-body {
        padding: 1rem;
    }
    .filter-card .form-label {
        font-size: 0.85rem;
        margin-bottom: 0.35rem;
    }
    .filter-card .form-select, .filter-card .form-control {
        font-size: 0.85rem;
        padding: 0.4rem 0.75rem;
    }
    .btn-cyan {
        background: linear-gradient(135deg, #06B6D4 0%, #0891b2 100%);
        color: white;
        border: 0;
        font-weight: 600;
        transition: all 0.3s;
        box-shadow: 0 2px 8px rgba(6, 182, 212, 0.2);
    }
    .btn-cyan:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
        color: white;
    }
    .stat-card-reports {
        border: 0;
        border-radius: 0.75rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border-top: 3px solid #06B6D4;
        transition: all 0.3s;
    }
    .stat-card-reports:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(6, 182, 212, 0.2);
    }
    .stat-card-reports .card-body {
        padding: 0.75rem 0.5rem;
    }
    .stat-card-reports h6 {
        font-size: 0.75rem;
        margin-bottom: 0.35rem;
    }
    .stat-card-reports h3 {
        color: #06B6D4;
        font-weight: 700;
        font-size: 1.5rem;
    }
    .table-card {
        border: 0;
        border-radius: 0.75rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border-left: 3px solid #06B6D4;
    }
    .table-card .card-header {
        background: linear-gradient(135deg, #f0fbff 0%, #e0f7fb 100%);
        border: 0;
        border-radius: 0.75rem 0.75rem 0 0;
        padding: 0.7rem 1rem;
    }
    .table-card .card-header h5 {
        color: #0891b2;
        font-weight: 700;
        font-size: 0.9rem;
    }
    .table-card .card-body {
        padding: 0.75rem;
        overflow-x: auto;
    }
    .table-card table {
        font-size: 0.85rem;
    }
    .table-card thead th {
        font-size: 0.8rem;
        padding: 0.6rem 0.75rem;
    }
    .table-card tbody td {
        padding: 0.6rem 0.75rem;
    }
    .pagination {
        margin: 0;
    }
    .pagination .page-link {
        color: #06B6D4;
        border-color: #e0f7fb;
        font-size: 0.85rem;
        padding: 0.4rem 0.75rem;
    }
    .pagination .page-link:hover {
        background-color: #f0fbff;
        border-color: #06B6D4;
    }
    .pagination .page-item.active .page-link {
        background: linear-gradient(135deg, #06B6D4 0%, #0891b2 100%);
        border-color: #06B6D4;
    }
    .form-select:focus, .form-control:focus {
        border-color: #06B6D4;
        box-shadow: 0 0 0 0.2rem rgba(6, 182, 212, 0.15);
    }
    .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    .table {
        white-space: nowrap;
    }
</style>
<div class="container-fluid py-3 px-3">
    <!-- Header -->
    <div class="reports-header">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div>
                <h2><i class="bi bi-bar-chart me-2"></i>Quiz Reports & Analytics</h2>
                <p>Filter and analyze quiz performance data</p>
            </div>
            <button class="btn btn-light" id="downloadPdfBtn" onclick="downloadReportPDF()">
                <i class="bi bi-download me-1"></i>Download PDF Report
            </button>
        </div>
    </div>

    <!-- Filters Card -->
    <div class="card filter-card shadow-sm mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-funnel me-2"></i>Filters</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <!-- Quiz Filter -->
                <div class="col-md-3">
                    <label class="form-label">Quiz</label>
                    <select class="form-select" id="quizFilter" onchange="applyFilters()">
                        <option value="">All Quizzes</option>
                        {% for quiz in quizzes %}
                            <option value="{{ quiz.id }}">{{ quiz.title }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Subject Filter -->
                <div class="col-md-3">
                    <label class="form-label">Subject</label>
                    <select class="form-select" id="subjectFilter" onchange="applyFilters()">
                        <option value="">All Subjects</option>
                        {% for subject in subjects %}
                            <option value="{{ subject.id }}">{{ subject.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Student Filter -->
                <div class="col-md-3">
                    <label class="form-label">Student</label>
                    <select class="form-select" id="studentFilter" onchange="applyFilters()">
                        <option value="">All Students</option>
                        {% for student in students %}
                            <option value="{{ student.id }}">{{ student.first_name }} {{ student.last_name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Difficulty Filter -->
                <div class="col-md-3">
                    <label class="form-label">Difficulty</label>
                    <select class="form-select" id="difficultyFilter" onchange="applyFilters()">
                        <option value="">All Difficulties</option>
                        <option value="easy">Easy</option>
                        <option value="medium">Medium</option>
                        <option value="hard">Hard</option>
                    </select>
                </div>

                <!-- Date Range -->
                <div class="col-md-3">
                    <label class="form-label">Start Date</label>
                    <input type="date" class="form-control" id="startDate" onchange="applyFilters()">
                </div>

                <div class="col-md-3">
                    <label class="form-label">End Date</label>
                    <input type="date" class="form-control" id="endDate" onchange="applyFilters()">
                </div>

                <!-- Score Range -->
                <div class="col-md-3">
                    <label class="form-label">Min Score</label>
                    <input type="number" class="form-control" id="minScore" min="0" onchange="applyFilters()" placeholder="0">
                </div>

                <div class="col-md-3">
                    <label class="form-label">Max Score</label>
                    <input type="number" class="form-control" id="maxScore" min="0" onchange="applyFilters()" placeholder="1000">
                </div>

                <!-- Search -->
                <div class="col-md-6">
                    <label class="form-label">Search</label>
                    <input type="text" class="form-control" id="searchBox" placeholder="Search quiz title or student name..." onkeyup="applyFilters()">
                </div>

                <!-- Reset Button -->
                <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-secondary w-100" onclick="resetFilters()">
                        <i class="bi bi-arrow-counterclockwise me-1"></i>Reset
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4" id="statsContainer">
        <div class="col-md-3">
            <div class="card stat-card-reports text-center">
                <div class="card-body py-3">
                    <h6 class="text-muted mb-2 small">Total Attempts</h6>
                    <h3 id="totalAttempts" class="mb-0">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card-reports text-center">
                <div class="card-body py-3">
                    <h6 class="text-muted mb-2 small">Average Score</h6>
                    <h3 id="avgScore" class="mb-0">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card-reports text-center">
                <div class="card-body py-3">
                    <h6 class="text-muted mb-2 small">Average Percentage</h6>
                    <h3 id="avgPercentage" class="mb-0">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card-reports text-center">
                <div class="card-body py-3">
                    <h6 class="text-muted mb-2 small">Unique Students</h6>
                    <h3 id="uniqueStudents" class="mb-0">-</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="card table-card shadow-sm">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-table me-2"></i>Attempt Details</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="attemptsTable">
                    <thead class="table-light">
                        <tr>
                            <th>Quiz</th>
                            <th>Student</th>
                            <th>Score</th>
                            <th>Percentage</th>
                            <th>Completed At</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">
                                <i class="bi bi-hourglass me-2"></i>Loading data...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-3">
                <small class="text-muted" id="recordCount">Total records: -</small>
                <nav>
                    <ul class="pagination pagination-sm mb-0" id="pagination">
                        <!-- Pagination will be generated by JavaScript -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<script>
let currentPage = 1;
const itemsPerPage = 10;
let allAttempts = [];

async function applyFilters(page = 1) {
    currentPage = page;
    const filters = {
        quiz_id: document.getElementById('quizFilter').value,
        subject_id: document.getElementById('subjectFilter').value,
        student_id: document.getElementById('studentFilter').value,
        difficulty: document.getElementById('difficultyFilter').value,
        start_date: document.getElementById('startDate').value,
        end_date: document.getElementById('endDate').value,
        min_score: document.getElementById('minScore').value,
        max_score: document.getElementById('maxScore').value,
        search: document.getElementById('searchBox').value
    };

    try {
        const response = await fetch('{% url "filter_quiz_reports" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(filters)
        });

        const data = await response.json();

        if (data.success) {
            allAttempts = data.attempts;
            updateStatistics(data.statistics);
            
            // Apply pagination
            const totalPages = Math.ceil(allAttempts.length / itemsPerPage);
            const startIdx = (currentPage - 1) * itemsPerPage;
            const endIdx = startIdx + itemsPerPage;
            const paginatedAttempts = allAttempts.slice(startIdx, endIdx);
            
            updateTable(paginatedAttempts);
            document.getElementById('recordCount').textContent = `Total records: ${allAttempts.length} (Page ${currentPage} of ${totalPages || 1})`;
            renderPagination(totalPages);
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error applying filters');
    }
}

function updateStatistics(stats) {
    document.getElementById('totalAttempts').textContent = stats.total_attempts;
    document.getElementById('avgScore').textContent = stats.avg_score || '-';
    document.getElementById('avgPercentage').textContent = (stats.avg_percentage ? stats.avg_percentage + '%' : '-');
    document.getElementById('uniqueStudents').textContent = stats.unique_students;
}

function updateTable(attempts) {
    const tbody = document.getElementById('tableBody');
    
    if (attempts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">No data found</td></tr>';
        return;
    }

    tbody.innerHTML = attempts.map(attempt => `
        <tr>
            <td><strong>${attempt.quiz_title}</strong></td>
            <td>${attempt.student_name}</td>
            <td>${attempt.score}/${attempt.total}</td>
            <td>
                <span class="badge" style="background-color: ${attempt.percentage >= 70 ? '#28a745' : attempt.percentage >= 50 ? '#ffc107' : '#dc3545'}">
                    ${attempt.percentage}%
                </span>
            </td>
            <td><small>${attempt.completed_at}</small></td>
            <td><span class="badge bg-info">${attempt.status}</span></td>
        </tr>
    `).join('');
}

function resetFilters() {
    document.getElementById('quizFilter').value = '';
    document.getElementById('subjectFilter').value = '';
    document.getElementById('studentFilter').value = '';
    document.getElementById('difficultyFilter').value = '';
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    document.getElementById('minScore').value = '';
    document.getElementById('maxScore').value = '';
    document.getElementById('searchBox').value = '';
    applyFilters();
}

function downloadReportPDF() {
    const filters = new URLSearchParams({
        quiz_id: document.getElementById('quizFilter').value,
        subject_id: document.getElementById('subjectFilter').value,
        student_id: document.getElementById('studentFilter').value,
        difficulty: document.getElementById('difficultyFilter').value,
        start_date: document.getElementById('startDate').value,
        end_date: document.getElementById('endDate').value,
        min_score: document.getElementById('minScore').value,
        max_score: document.getElementById('maxScore').value
    });

    window.location.href = `{% url 'download_quiz_report_pdf' %}?${filters.toString()}`;
}

function renderPagination(totalPages) {
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    
    if (totalPages <= 1) return;
    
    // Previous button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" onclick="applyFilters(${currentPage - 1}); return false;">Previous</a>`;
    pagination.appendChild(prevLi);
    
    // Page numbers
    const maxVisible = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
    let endPage = Math.min(totalPages, startPage + maxVisible - 1);
    
    if (endPage - startPage < maxVisible - 1) {
        startPage = Math.max(1, endPage - maxVisible + 1);
    }
    
    if (startPage > 1) {
        const firstLi = document.createElement('li');
        firstLi.className = 'page-item';
        firstLi.innerHTML = `<a class="page-link" href="#" onclick="applyFilters(1); return false;">1</a>`;
        pagination.appendChild(firstLi);
        
        if (startPage > 2) {
            const dotsLi = document.createElement('li');
            dotsLi.className = 'page-item disabled';
            dotsLi.innerHTML = '<span class="page-link">...</span>';
            pagination.appendChild(dotsLi);
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" onclick="applyFilters(${i}); return false;">${i}</a>`;
        pagination.appendChild(li);
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            const dotsLi = document.createElement('li');
            dotsLi.className = 'page-item disabled';
            dotsLi.innerHTML = '<span class="page-link">...</span>';
            pagination.appendChild(dotsLi);
        }
        
        const lastLi = document.createElement('li');
        lastLi.className = 'page-item';
        lastLi.innerHTML = `<a class="page-link" href="#" onclick="applyFilters(${totalPages}); return false;">${totalPages}</a>`;
        pagination.appendChild(lastLi);
    }
    
    // Next button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" onclick="applyFilters(${currentPage + 1}); return false;">Next</a>`;
    pagination.appendChild(nextLi);
}

// Load initial data
applyFilters();
</script>

<style>
.table-hover tbody tr:hover {
    background-color: #f0fbff !important;
}

.badge {
    font-weight: 600;
    padding: 0.5rem 0.75rem;
}
</style>
{% endblock %}
