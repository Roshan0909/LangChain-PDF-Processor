{% extends 'teachers/base_teacher.html' %}

{% block title %}Quiz Analytics{% endblock %}

{% block teacher_content %}
<style>
    :root {
        --chat-cyan: #06B6D4;
        --chat-cyan-strong: #0891b2;
        --chat-dark: #0f172a;
    }
    body { overflow-x: hidden; }
    .analytics-tab { display: none; }
    #overviewTab { display: block; }
    .page-header {
        background: linear-gradient(135deg, #e0f7fb 0%, #f0fbff 50%, #f8fdff 100%);
        padding: 1.25rem 1rem;
        margin-bottom: 1.25rem;
        border-bottom: 1px solid rgba(6, 182, 212, 0.1);
    }
    .page-title {
        font-size: 1.5rem;
        font-weight: 800;
        color: #0f172a;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        letter-spacing: -0.4px;
    }
    .page-title i {
        color: var(--chat-cyan);
        font-size: 1.6rem;
    }
    .tab-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    .tab-buttons .btn {
        border: 2px solid #e2e8f0;
        color: #64748B;
        font-weight: 700;
        border-radius: 0.5rem;
        padding: 0.55rem 1rem;
        transition: all 0.3s;
    }
    .tab-buttons .btn:hover {
        border-color: var(--chat-cyan);
        color: var(--chat-cyan);
    }
    .tab-buttons .btn.active {
        background: linear-gradient(135deg, var(--chat-cyan) 0%, var(--chat-cyan-strong) 100%);
        color: white;
        border-color: transparent;
        box-shadow: 0 4px 10px rgba(6, 182, 212, 0.22);
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.25rem;
    }
    .stat-card {
        background: white;
        border-radius: 0.75rem;
        padding: 1.05rem;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04), 0 3px 10px rgba(0, 0, 0, 0.06);
        border-top: 3px solid var(--chat-cyan);
        transition: all 0.25s ease;
        text-align: center;
    }
    .stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(6, 182, 212, 0.12);
    }
    .stat-value {
        font-size: 1.8rem;
        font-weight: 800;
        color: var(--chat-cyan);
        margin-bottom: 0.35rem;
        line-height: 1;
    }
    .stat-label {
        color: #64748B;
        font-size: 0.85rem;
        font-weight: 600;
        letter-spacing: 0.2px;
        text-transform: uppercase;
    }
    .quiz-cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 1rem;
        margin-top: 1.25rem;
    }
    .quiz-card {
        background: white;
        border-radius: 0.75rem;
        overflow: hidden;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04), 0 3px 10px rgba(0, 0, 0, 0.08);
        border-left: 3px solid var(--chat-cyan);
        transition: all 0.25s ease;
        display: flex;
        flex-direction: column;
    }
    .quiz-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 22px rgba(6, 182, 212, 0.15);
    }
    .quiz-card-header {
        background: linear-gradient(135deg, var(--chat-cyan) 0%, var(--chat-cyan-strong) 100%);
        color: white;
        padding: 1rem 1rem 0.9rem;
        font-weight: 700;
        font-size: 0.95rem;
        line-height: 1.35;
        min-height: 52px;
        display: flex;
        align-items: center;
    }
    .quiz-card-body {
        padding: 1rem;
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    .quiz-subject {
        color: #64748B;
        font-size: 0.8rem;
        font-weight: 600;
        margin-bottom: 0.6rem;
        display: flex;
        align-items: center;
        gap: 0.3rem;
    }
    .quiz-subject i {
        color: var(--chat-cyan);
    }
    .quiz-stats {
        display: flex;
        gap: 0.4rem;
        margin-bottom: 0.75rem;
        flex-wrap: wrap;
    }
    .quiz-badge {
        display: inline-block;
        padding: 0.3rem 0.65rem;
        background: linear-gradient(135deg, #E0F2FE 0%, #CFFAFE 100%);
        border: 1px solid rgba(6, 182, 212, 0.2);
        border-radius: 0.5rem;
        font-size: 0.75rem;
        font-weight: 700;
        color: var(--chat-cyan);
    }
    .progress-section {
        margin-bottom: 0.75rem;
        flex: 1;
    }
    .progress-bar-container {
        background: #f1f5f9;
        border-radius: 0.4rem;
        overflow: hidden;
        height: 6px;
        margin-top: 0.5rem;
    }
    .progress-bar {
        background: linear-gradient(90deg, var(--chat-cyan) 0%, var(--chat-cyan-strong) 100%);
        height: 100%;
        transition: width 0.3s ease;
    }
    .card-actions {
        display: flex;
        gap: 0.4rem;
        margin-top: auto;
    }
    .card-action-btn {
        flex: 1;
        padding: 0.55rem;
        border: 2px solid #e2e8f0;
        border-radius: 0.5rem;
        background: white;
        color: #64748B;
        font-weight: 700;
        font-size: 0.78rem;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.3rem;
    }
    /* Local confirm overrides */
    .custom-confirm-overlay { background: rgba(15,23,42,0.55); backdrop-filter: blur(8px); }
    .custom-confirm-dialog { max-width: 360px; width: 90%; padding: 14px 14px 12px; border-radius: 12px; box-shadow: 0 14px 34px rgba(6,182,212,0.22); border: 1px solid rgba(6,182,212,0.18); }
    .custom-confirm-icon { width: 48px; height: 48px; font-size: 24px; margin-bottom: 10px; border-radius: 10px; background: linear-gradient(135deg, #06B6D4 0%, #0891b2 100%); box-shadow: 0 8px 18px rgba(6,182,212,0.28); }
    .custom-confirm-title { font-size: 17px; margin-bottom: 6px; letter-spacing: -0.2px; color: #0f172a; }
    .custom-confirm-message { font-size: 14px; margin-bottom: 14px; color: #334155; }
    .custom-confirm-buttons { gap: 8px; }
    .custom-confirm-btn { padding: 9px 10px; font-size: 13px; border-radius: 9px; }
    .custom-confirm-btn-yes { background: linear-gradient(135deg, #06B6D4 0%, #0891b2 100%); color: #fff; box-shadow: 0 8px 16px rgba(6,182,212,0.25); }
    .custom-confirm-btn-no { background: #fff; color: #0f172a; border: 2px solid #e2e8f0; }
    /* Student performance cards */
    .student-card {
        background: white;
        border-radius: 0.75rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05), 0 6px 18px rgba(6,182,212,0.12);
        border-left: 3px solid var(--chat-cyan);
        cursor: pointer;
        transition: all 0.25s ease;
    }
    .student-card .card-body { padding: 1rem; }
    .student-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 24px rgba(6,182,212,0.18);
    }
    .student-title { color: var(--chat-dark); font-weight: 700; }
    .student-icon { color: var(--chat-cyan); }
    .student-badge {
        background: #e0f7fb;
        color: var(--chat-dark);
        border: 1px solid rgba(6,182,212,0.2);
        border-radius: 999px;
        font-weight: 700;
        padding: 0.3rem 0.65rem;
    }
    .student-progress { height: 7px; background: #f1f5f9; border-radius: 999px; overflow: hidden; }
    .student-progress .progress-bar { background: linear-gradient(90deg, var(--chat-cyan) 0%, var(--chat-cyan-strong) 100%); }
    .student-modal-header { background: linear-gradient(135deg, var(--chat-cyan) 0%, var(--chat-cyan-strong) 100%); color: #fff; }
    .student-avatar { width: 32px; height: 32px; border-radius: 10px; background: linear-gradient(135deg, #06B6D4 0%, #0891b2 100%); color: #fff; font-weight: 700; display: inline-flex; align-items: center; justify-content: center; font-size: 14px; }
    .badge-cyan { background: rgba(6,182,212,0.12); color: #0f172a; border: 1px solid rgba(6,182,212,0.25); }
    .student-table thead th { background: #f8fafc; color: #0f172a; font-weight: 700; border-bottom: 1px solid #e2e8f0; }
    .student-table td, .student-table th { padding: 0.65rem 0.75rem; vertical-align: middle; }
    /* Quiz Details styles */
    .detail-card {
        border: none;
        border-radius: 0.75rem;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05), 0 6px 18px rgba(6,182,212,0.12);
        border-left: 3px solid var(--chat-cyan);
    }
    .detail-header {
        background: linear-gradient(135deg, var(--chat-cyan) 0%, var(--chat-cyan-strong) 100%);
        color: #fff;
        padding: 0.9rem 1rem;
    }
    .detail-header h5 { margin: 0; font-weight: 700; font-size: 1rem; }
    .detail-header small { color: rgba(255,255,255,0.8); }
    .detail-body { padding: 1rem; }
    .detail-meta { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
    .info-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.35rem 0.65rem;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        font-weight: 600;
        color: #0f172a;
        font-size: 0.85rem;
    }
    .status-badge {
        padding: 0.35rem 0.65rem;
        border-radius: 999px;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.85rem;
    }
    .status-badge.active { background: #ecfdf3; color: #15803d; border: 1px solid #bbf7d0; }
    .status-badge.inactive { background: #f8fafc; color: #475569; border: 1px solid #e2e8f0; }
    .stat-chip {
        background: #f8fafc;
        border-radius: 0.6rem;
        padding: 0.75rem;
        text-align: center;
        border: 1px solid #e2e8f0;
    }
    .stat-chip h3 { margin: 0; font-size: 1.35rem; font-weight: 800; color: var(--chat-cyan); }
    .stat-chip small { color: #64748B; font-weight: 600; }
    .detail-progress {
        background: #f1f5f9;
        border-radius: 0.5rem;
        overflow: hidden;
        height: 22px;
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
    }
    .detail-progress .progress-bar {
        background: linear-gradient(90deg, var(--chat-cyan) 0%, var(--chat-cyan-strong) 100%);
        font-weight: 700;
        font-size: 0.85rem;
    }
    .detail-info-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        gap: 0.35rem;
    }
    .detail-info-list li {
        color: #0f172a;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }
    .detail-info-list li i { color: var(--chat-cyan); }
    .card-action-btn:hover {
        border-color: var(--chat-cyan);
        color: var(--chat-cyan);
        background: rgba(6, 182, 212, 0.05);
    }
    .correct-answer { 
        background-color: #d4edda; 
        padding: 10px; 
        border-radius: 5px; 
        border-left: 4px solid #28a745; 
    }
    .question { 
        margin-bottom: 30px; 
        page-break-inside: avoid; 
    }
    .violation-section {
        transition: all 0.3s ease;
    }
    .violation-section:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
        transform: translateY(-2px);
    }
    .snapshot-thumb img {
        transition: transform 0.3s ease;
    }
    .snapshot-thumb:hover img {
        transform: scale(1.05);
    }
    @media print { 
        .no-print { display: none; }
        body { padding: 10px; }
    }
    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }
        .quiz-cards-grid {
            grid-template-columns: 1fr;
        }
        .page-title {
            font-size: 1.4rem;
        }
        .tab-buttons {
            flex-direction: column;
        }
        .tab-buttons .btn {
            width: 100%;
        }
    }
</style>

<div class="page-header">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-3 mb-3">
        <h2 class="page-title">
            <i class="bi bi-graph-up"></i>
            Quiz Analytics Dashboard
        </h2>
        <div class="tab-buttons">
            <button type="button" class="btn active" data-tab="overview" onclick="showTab('overview')">
                <i class="bi bi-graph-up"></i> Overview
            </button>
            <button type="button" class="btn" data-tab="details" onclick="showTab('details')">
                <i class="bi bi-list-check"></i> Quiz Details
            </button>
            <button type="button" class="btn" data-tab="students" onclick="showTab('students')">
                <i class="bi bi-people"></i> Student Performance
            </button>
            <button type="button" class="btn" data-tab="proctoring" onclick="showTab('proctoring')">
                <i class="bi bi-camera-video"></i> Proctoring Reports
            </button>
        </div>
    </div>
</div>

<div style="padding: 0 1rem;">
    {% if quiz_stats %}
        <!-- Overview Tab -->
        <div id="overviewTab" class="analytics-tab">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value">{{ quiz_stats|length }}</div>
                    <div class="stat-label">Total Quizzes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ total_attempts }}</div>
                    <div class="stat-label">Total Attempts</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ unique_students }}</div>
                    <div class="stat-label">Active Students</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ overall_avg }}%</div>
                    <div class="stat-label">Average Score</div>
                </div>
            </div>
            
            <div class="quiz-cards-grid">
                {% for stat in quiz_stats %}
                    <div class="quiz-card">
                        <div class="quiz-card-header">
                            <i class="bi bi-clipboard-check me-2"></i>
                            {{ stat.quiz.title }}
                        </div>
                        <div class="quiz-card-body">
                            <div class="quiz-subject">
                                <i class="bi bi-book"></i>
                                {{ stat.quiz.subject.name }}
                            </div>
                            
                            <div class="quiz-stats">
                                <span class="quiz-badge">
                                    <i class="bi bi-play-circle"></i> {{ stat.total_attempts }} attempts
                                </span>
                                <span class="quiz-badge">
                                    <i class="bi bi-percent"></i> {{ stat.avg_percentage }}% avg
                                </span>
                            </div>
                            
                            <div class="progress-section">
                                <small style="color: #64748B; font-weight: 600;">Performance</small>
                                <div class="progress-bar-container">
                                    <div class="progress-bar" style="width: {{ stat.avg_percentage }}%;"></div>
                                </div>
                            </div>
                            
                            <div class="card-actions">
                                <button class="card-action-btn" onclick="copyQuizContent{{ stat.quiz.id }}()" title="Copy Questions & Answers">
                                    <i class="bi bi-clipboard"></i>
                                    <span>Copy Q&A</span>
                                </button>
                                <button class="card-action-btn" onclick="viewAnswerSheet{{ stat.quiz.id }}()" title="View Answer Sheet">
                                    <i class="bi bi-eye"></i>
                                    <span>Answers</span>
                                </button>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Quiz Details Tab -->
        <div id="detailsTab" class="analytics-tab" style="display: none;">
            {% for stat in quiz_stats %}
                <div class="detail-card mb-4">
                    <div class="detail-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-0">{{ stat.quiz.title }}</h5>
                                <div class="detail-meta mt-1">
                                    <span class="info-chip"><i class="bi bi-book"></i>{{ stat.quiz.subject.name }}</span>
                                    {% if stat.quiz.deadline %}
                                        <span class="info-chip"><i class="bi bi-calendar-event"></i>Deadline: {{ stat.quiz.deadline|date:"M d, Y g:i A" }}</span>
                                    {% else %}
                                        <span class="info-chip"><i class="bi bi-calendar-x"></i>No deadline</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="d-flex gap-2 align-items-center">
                                {% if stat.quiz.is_active %}
                                    <span class="status-badge active"><i class="bi bi-circle-fill"></i> Active</span>
                                {% else %}
                                    <span class="status-badge inactive"><i class="bi bi-circle-fill"></i> Inactive</span>
                                {% endif %}
                                <div class="btn-group">
                                    <a href="{% url 'quiz_detail' stat.quiz.id %}" class="btn btn-light btn-sm" title="Edit Quiz">
                                        <i class="bi bi-pencil-square"></i> Edit
                                    </a>
                                    <button type="button" class="btn btn-sm toggle-quiz-btn {% if stat.quiz.is_active %}btn-warning{% else %}btn-success{% endif %}" 
                                            data-quiz-id="{{ stat.quiz.id }}" data-is-active="{{ stat.quiz.is_active }}" title="{% if stat.quiz.is_active %}Deactivate{% else %}Activate{% endif %} Quiz">
                                        <i class="bi {% if stat.quiz.is_active %}bi-pause-circle{% else %}bi-play-circle{% endif %}"></i>
                                        {% if stat.quiz.is_active %}Deactivate{% else %}Activate{% endif %}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="detail-body">
                        <div class="row mb-3 g-2">
                            <div class="col-6 col-md-3">
                                <div class="stat-chip">
                                    <h3 class="mb-1">{{ stat.total_attempts }}</h3>
                                    <small>Total Attempts</small>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="stat-chip">
                                    <h3 class="mb-1">{{ stat.total_questions }}</h3>
                                    <small>Questions</small>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="stat-chip">
                                    <h3 class="mb-1">{{ stat.avg_score }}</h3>
                                    <small>Avg Score</small>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="stat-chip">
                                    <h3 class="mb-1">{{ stat.quiz.duration }}</h3>
                                    <small>Minutes</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <h6 class="mb-0 text-secondary">Performance Overview</h6>
                                <span class="fw-bold" style="color: var(--chat-cyan);">{{ stat.avg_percentage }}%</span>
                            </div>
                            <div class="detail-progress">
                                <div class="progress-bar" style="width: {{ stat.avg_percentage }}%;" role="progressbar">
                                    <span class="ms-2">{{ stat.avg_percentage }}% Average</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <h6 class="text-secondary">Quiz Information</h6>
                                <ul class="detail-info-list">
                                    <li><i class="bi bi-file-pdf"></i> PDF: {{ stat.quiz.pdf_note.title }}</li>
                                    <li><i class="bi bi-calendar"></i> Created: {{ stat.quiz.created_at|date:"M d, Y" }}</li>
                                    <li><i class="bi bi-person"></i> Creator: {{ stat.quiz.created_by.username }}</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-secondary">Statistics</h6>
                                <ul class="detail-info-list">
                                    <li><i class="bi bi-graph-up"></i> Highest: {{ stat.highest_score }}/{{ stat.total_questions }}</li>
                                    <li><i class="bi bi-graph-down"></i> Lowest: {{ stat.lowest_score }}/{{ stat.total_questions }}</li>
                                    <li><i class="bi bi-people"></i> Unique Students: {{ stat.unique_students }}</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
        
        <!-- Student Performance Tab -->
        <div id="studentsTab" class="analytics-tab" style="display: none;">
            <div class="row g-3">
                {% for stat in quiz_stats %}
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="student-card h-100" data-bs-toggle="modal" data-bs-target="#studentModal{{ stat.quiz.id }}">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="mb-0 flex-grow-1 student-title">
                                        <i class="bi bi-clipboard-check student-icon"></i> {{ stat.quiz.title|truncatewords:6 }}
                                    </h6>
                                    <i class="bi bi-eye student-icon"></i>
                                </div>
                                <p class="text-muted small mb-2">
                                    <i class="bi bi-book"></i> {{ stat.quiz.subject.name }}
                                </p>
                                <div class="d-flex gap-2 mb-2 flex-wrap">
                                    <span class="student-badge">{{ stat.total_attempts }} attempts</span>
                                    <span class="student-badge">{{ stat.avg_percentage }}% avg</span>
                                </div>
                                <div class="student-progress">
                                    <div class="progress-bar" style="width: {{ stat.avg_percentage }}%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Student Performance Modal -->
                    <div class="modal fade" id="studentModal{{ stat.quiz.id }}" tabindex="-1" aria-labelledby="studentModalLabel{{ stat.quiz.id }}" aria-hidden="true">
                        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
                            <div class="modal-content">
                                <div class="modal-header student-modal-header">
                                    <div>
                                        <h5 class="modal-title" id="studentModalLabel{{ stat.quiz.id }}">
                                            <i class="bi bi-people"></i> Student Performance
                                        </h5>
                                        <small>{{ stat.quiz.title }}</small>
                                    </div>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body" style="padding: 0.75rem 0.75rem 0.25rem;">
                                    {% with completed_attempts=stat.quiz.attempts.all %}
                                        {% if completed_attempts %}
                                            <div class="table-responsive">
                                                <table class="table table-hover mb-0 align-middle student-table">
                                                    <thead>
                                                        <tr>
                                                            <th class="ps-3">Student</th>
                                                            <th class="text-center">Score</th>
                                                            <th>Percentage</th>
                                                            <th class="text-center">Grade</th>
                                                            <th class="text-center">Completed</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for attempt in completed_attempts %}
                                                            {% if attempt.completed_at and attempt.score is not None and stat.total_questions > 0 %}
                                                                <tr>
                                                                    <td class="ps-3">
                                                                        <div class="d-flex align-items-center">
                                                                            <div class="student-avatar me-2">
                                                                                {{ attempt.student.username|slice:":1"|upper }}
                                                                            </div>
                                                                            <strong>{{ attempt.student.username }}</strong>
                                                                        </div>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <span class="badge bg-light text-dark px-2 py-1">{{ attempt.score }}/{{ stat.total_questions }}</span>
                                                                    </td>
                                                                    <td>
                                                                        <script>
                                                                            var percentageValue{{ attempt.id }} = Math.round(({{ attempt.score }} / {{ stat.total_questions }}) * 100);
                                                                            document.write('<div class="progress" style="height: 18px; min-width: 110px; background:#f1f5f9;">');
                                                                            var bgColor = percentageValue{{ attempt.id }} >= 90 ? '#22c55e' : 
                                                                                        percentageValue{{ attempt.id }} >= 75 ? '#06B6D4' : 
                                                                                        percentageValue{{ attempt.id }} >= 50 ? '#fbbf24' : 
                                                                                        percentageValue{{ attempt.id }} >= 35 ? '#0ea5e9' : '#ef4444';
                                                                            document.write('<div class="progress-bar fw-bold" style="width: ' + percentageValue{{ attempt.id }} + '%; background-color: ' + bgColor + ';" role="progressbar">');
                                                                            document.write('<small>' + percentageValue{{ attempt.id }} + '%</small>');
                                                                            document.write('</div></div>');
                                                                        </script>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <script>
                                                                            var grade{{ attempt.id }} = percentageValue{{ attempt.id }} >= 90 ? 'A' : 
                                                                                                        percentageValue{{ attempt.id }} >= 75 ? 'B' : 
                                                                                                        percentageValue{{ attempt.id }} >= 50 ? 'C' : 
                                                                                                        percentageValue{{ attempt.id }} >= 35 ? 'D' : 'F';
                                                                            var badgeClass{{ attempt.id }} = percentageValue{{ attempt.id }} >= 90 ? 'bg-success' : 
                                                                                                            percentageValue{{ attempt.id }} >= 75 ? 'badge-cyan' : 
                                                                                                            percentageValue{{ attempt.id }} >= 50 ? 'bg-warning text-dark' : 
                                                                                                            percentageValue{{ attempt.id }} >= 35 ? 'bg-info text-dark' : 'bg-danger text-white';
                                                                            document.write('<span class="badge px-3 py-2 ' + badgeClass{{ attempt.id }} + '">' + grade{{ attempt.id }} + '</span>');
                                                                        </script>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <small class="text-muted">
                                                                            {{ attempt.completed_at|date:"M d, Y" }}<br>
                                                                            {{ attempt.completed_at|date:"g:i A" }}
                                                                        </small>
                                                                    </td>
                                                                </tr>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        {% else %}
                                            <div class="p-4 text-center text-muted">
                                                <i class="bi bi-info-circle fs-3"></i>
                                                <p class="mb-0 mt-2">No attempts yet for this quiz</p>
                                            </div>
                                        {% endif %}
                                    {% endwith %}
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            {% if not quiz_stats %}
                <div class="alert alert-info d-flex align-items-center">
                    <i class="bi bi-info-circle me-2 fs-4"></i>
                    <span>No quiz attempts yet</span>
                </div>
            {% endif %}
        </div>
        
        <!-- Proctoring Reports Tab -->
        <div id="proctoringTab" class="analytics-tab" style="display: none;">
            {% if proctoring_data %}
                <div class="row">
                    {% for item in proctoring_data %}
                        <div class="col-12 mb-5">
                            <div class="card shadow-lg border-0">
                                <div class="card-header text-white" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h4 class="mb-1"><i class="bi bi-clipboard-check"></i> {{ item.quiz.title }}</h4>
                                            <div>
                                                <span class="badge bg-white text-dark me-2">
                                                    <i class="bi bi-book"></i> {{ item.quiz.subject.name }}
                                                </span>
                                                <span class="badge bg-white text-dark">
                                                    <i class="bi bi-people"></i> {{ item.attempts_with_violations.count }} Student{{ item.attempts_with_violations.count|pluralize }}
                                                </span>
                                            </div>
                                        </div>
                                        <span class="badge bg-white text-danger fs-4 px-3 py-2">
                                            <i class="bi bi-exclamation-triangle-fill"></i> {{ item.total_violations }} Violation{{ item.total_violations|pluralize }}
                                        </span>
                                    </div>
                                </div>
                                <div class="card-body p-4">
                                    {% for attempt in item.attempts_with_violations %}
                                        <div class="violation-section mb-4 p-3 {% if attempt.completed_at %}bg-light{% else %}bg-warning bg-opacity-10{% endif %}" 
                                             style="border-left: 4px solid {% if attempt.completed_at %}#198754{% else %}#ffc107{% endif %}; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                            <div class="d-flex justify-content-between align-items-start mb-3">
                                                <div>
                                                    <h6 class="mb-1">
                                                        <i class="bi bi-person-circle"></i> {{ attempt.student.get_full_name|default:attempt.student.username }}
                                                    </h6>
                                                    <small class="text-muted">
                                                        {% if attempt.completed_at %}
                                                            <i class="bi bi-clock"></i> Completed: {{ attempt.completed_at|date:"M d, Y g:i A" }}
                                                            | <i class="bi bi-trophy"></i> Score: <strong>{{ attempt.score }}/{{ item.quiz.questions.count }}</strong>
                                                            ({{ attempt.score|floatformat:0 }}{% widthratio attempt.score item.quiz.questions.count 100 %}%)
                                                        {% else %}
                                                            <i class="bi bi-clock"></i> Started: {{ attempt.started_at|date:"M d, Y g:i A" }}
                                                        {% endif %}
                                                    </small>
                                                </div>
                                                <div class="text-end">
                                                    <span class="badge bg-danger me-1 px-2 py-1">
                                                        <i class="bi bi-camera"></i> {{ attempt.snapshots.count }} Snapshot{{ attempt.snapshots.count|pluralize }}
                                                    </span>
                                                    <span class="badge bg-info me-1 px-2 py-1">
                                                        <i class="bi bi-arrow-left-right"></i> {{ attempt.tab_switch_count }} Tab Switch{{ attempt.tab_switch_count|pluralize:"es" }}
                                                    </span>
                                                    <span class="badge bg-secondary px-2 py-1">
                                                        <i class="bi bi-fullscreen-exit"></i> {{ attempt.fullscreen_exit_count }} FS Exit{{ attempt.fullscreen_exit_count|pluralize }}
                                                    </span>
                                                </div>
                                            </div>
                                            
                                            {% if attempt.snapshots.all %}
                                                <div class="row g-3 mt-2">
                                                    {% for snapshot in attempt.snapshots.all %}
                                                        <div class="col-md-3">
                                                            <div class="snapshot-thumb position-relative">
                                                                <img src="{{ snapshot.image.url }}" class="img-fluid rounded shadow-sm" alt="Violation" style="width: 100%; height: 150px; object-fit: cover; cursor: pointer;" onclick="viewFullSnapshot('{{ snapshot.image.url }}', '{{ snapshot.violation_type }}', '{{ snapshot.timestamp|date:"M d, g:i A" }}')">
                                                                <span class="badge position-absolute top-0 start-0 m-2
                                                                    {% if snapshot.violation_type == 'no_person' %}bg-warning
                                                                    {% elif snapshot.violation_type == 'multiple_persons' %}bg-danger
                                                                    {% else %}bg-info
                                                                    {% endif %}">
                                                                    {% if snapshot.violation_type == 'no_person' %}
                                                                        <i class="bi bi-person-x"></i> No Person
                                                                    {% elif snapshot.violation_type == 'multiple_persons' %}
                                                                        <i class="bi bi-people-fill"></i> {{ snapshot.person_count }} Persons
                                                                    {% else %}
                                                                        <i class="bi bi-phone-fill"></i> Phone
                                                                    {% endif %}
                                                                </span>
                                                                <span class="badge bg-dark position-absolute bottom-0 end-0 m-2">
                                                                    <i class="bi bi-clock"></i> {{ snapshot.timestamp|date:"g:i A" }}
                                                                </span>
                                                            </div>
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-check-circle text-success" style="font-size: 5rem;"></i>
                    <h4 class="mt-3 text-muted">No Violations Detected</h4>
                    <p class="text-muted">All students followed quiz rules properly.</p>
                </div>
            {% endif %}
        </div>
    {% else %}
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> No quizzes created yet. Go to "Create Quiz" to generate your first quiz.
        </div>
    {% endif %}
</div>

<!-- Answer Sheet Modal -->
<div class="modal fade" id="answerSheetModal" tabindex="-1" aria-labelledby="answerSheetModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h5 class="modal-title" id="answerSheetModalLabel">Answer Sheet</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="answerSheetContent">
                <!-- Content will be dynamically loaded here -->
            </div>
            <div class="modal-footer no-print">
                <button type="button" class="btn btn-primary" onclick="window.print()">
                    <i class="bi bi-printer"></i> Print
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Snapshot Viewer Modal -->
<div class="modal fade" id="snapshotModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="bi bi-camera-video"></i> <span id="snapshotTitle">Violation Snapshot</span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="snapshotImage" src="" class="img-fluid rounded" alt="Snapshot">
                <p class="mt-3 text-muted" id="snapshotTime"></p>
            </div>
        </div>
    </div>
</div>

<script>
    function showTab(tabName) {
        // Save current tab to localStorage
        localStorage.setItem('quizAnalyticsActiveTab', tabName);

        // Hide all tabs
        document.querySelectorAll('.analytics-tab').forEach(tab => {
            tab.style.display = 'none';
        });

        // Remove active class from all tab buttons
        document.querySelectorAll('.tab-buttons .btn').forEach(btn => {
            btn.classList.remove('active');
        });

        // Show selected tab and highlight current button
        const targetTab = document.getElementById(`${tabName}Tab`);
        if (targetTab) {
            targetTab.style.display = 'block';
        }
        const targetBtn = document.querySelector(`.tab-buttons .btn[data-tab="${tabName}"]`);
        if (targetBtn) {
            targetBtn.classList.add('active');
        }
    }
    
    // Restore active tab on page load
    document.addEventListener('DOMContentLoaded', function() {
        const savedTab = localStorage.getItem('quizAnalyticsActiveTab') || 'overview';
        showTab(savedTab);
    });

    // View full snapshot in modal
    function viewFullSnapshot(imageSrc, violationType, timestamp) {
        const modal = new bootstrap.Modal(document.getElementById('snapshotModal'));
        document.getElementById('snapshotImage').src = imageSrc;
        document.getElementById('snapshotTitle').textContent = violationType + ' - Violation Snapshot';
        document.getElementById('snapshotTime').textContent = 'Captured: ' + timestamp;
        modal.show();
    }

    // Toggle quiz active/inactive
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOMContentLoaded - setting up toggle buttons');
        const buttons = document.querySelectorAll('.toggle-quiz-btn');
        console.log('Found toggle buttons:', buttons.length);
        
        buttons.forEach(btn => {
            btn.addEventListener('click', function() {
                console.log('Toggle button clicked');
                const quizId = this.getAttribute('data-quiz-id');
                const isActive = this.getAttribute('data-is-active') === 'True';
                console.log('Quiz ID:', quizId, 'Is Active:', isActive);
                
                if (typeof customConfirm === 'undefined') {
                    console.error('customConfirm is not defined!');
                    alert('Error: Custom confirm dialog not loaded');
                    return;
                }
                
                customConfirm(`Are you sure you want to ${isActive ? 'deactivate' : 'activate'} this quiz?`, function(result) {
                    console.log('Confirm result:', result);
                    if (result) {
                        fetch(`/teacher/quiz/${quizId}/toggle/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}'
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Save current tab before reload
                                const currentTab = localStorage.getItem('quizAnalyticsActiveTab') || 'details';
                                localStorage.setItem('quizAnalyticsActiveTab', currentTab);
                                location.reload();
                            } else {
                                alert(data.error || 'Failed to toggle quiz status');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('An error occurred while updating quiz status');
                        });
                    }
                });
            });
        });
    });

    // Generate Copy and View functions for each quiz
    {% for stat in quiz_stats %}
    // Copy Quiz Content for Quiz ID {{ stat.quiz.id }}
    function copyQuizContent{{ stat.quiz.id }}() {
        let text = '{{ stat.quiz.title|escapejs }}\\n';
        text += 'Subject: {{ stat.quiz.subject.name|escapejs }}\\n';
        text += 'Total Questions: {{ stat.total_questions }}\\n';
        text += 'Duration: {{ stat.quiz.duration }} minutes\\n';
        text += '\\n' + '='.repeat(60) + '\\n\\n';
        
        {% for question in stat.quiz.questions.all %}
        text += 'Question {{ forloop.counter }}:\\n';
        text += '{{ question.text|escapejs }}\\n\\n';
        {% if question.question_type == 'multiple_choice' %}
        {% for option in question.options %}
        text += '  {{ forloop.counter }}. {{ option|escapejs }}\\n';
        {% endfor %}
        text += '\\nCorrect Answer: Option {{ question.correct_answer|add:1 }}\\n';
        {% elif question.question_type == 'true_false' %}
        text += 'Correct Answer: {% if question.correct_answer == "0" %}True{% else %}False{% endif %}\\n';
        {% else %}
        text += 'Correct Answer: {{ question.correct_answer|escapejs }}\\n';
        {% endif %}
        text += '\\n' + '-'.repeat(60) + '\\n\\n';
        {% endfor %}
        
        navigator.clipboard.writeText(text).then(function() {
            alert('Quiz content copied to clipboard!');
        }, function(err) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                alert('Quiz content copied to clipboard!');
            } catch (e) {
                alert('Failed to copy. Please try again.');
            }
            document.body.removeChild(textarea);
        });
    }

    // View Answer Sheet for Quiz ID {{ stat.quiz.id }}
    function viewAnswerSheet{{ stat.quiz.id }}() {
        let html = `
            <div class="mb-3">
                <strong>Subject:</strong> {{ stat.quiz.subject.name|escapejs }}<br>
                <strong>Total Questions:</strong> {{ stat.total_questions }}<br>
                <strong>Duration:</strong> {{ stat.quiz.duration }} minutes
            </div>
            <hr>
        `;
        
        {% for question in stat.quiz.questions.all %}
        html += `
            <div class="question mb-4">
                <h5 class="text-primary">Question {{ forloop.counter }}</h5>
                <p><strong>{{ question.text|escapejs }}</strong></p>
                {% if question.question_type == 'multiple_choice' %}
                <div class="options mb-2">
                    {% for option in question.options %}
                    <div class="{% if forloop.counter0|add:0 == question.correct_answer|add:0 %}correct-answer{% endif %} mb-1 p-2">
                        {{ forloop.counter }}. {{ option|escapejs }}
                        {% if forloop.counter0|add:0 == question.correct_answer|add:0 %}<strong>  (Correct Answer)</strong>{% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% elif question.question_type == 'true_false' %}
                <div class="correct-answer">
                    <strong>Correct Answer:</strong> {% if question.correct_answer == '0' %}True{% else %}False{% endif %}
                </div>
                {% else %}
                <div class="correct-answer">
                    <strong>Correct Answer:</strong> {{ question.correct_answer|escapejs }}
                </div>
                {% endif %}
            </div>
        `;
        {% endfor %}
        
        // Update modal content
        document.getElementById('answerSheetModalLabel').textContent = '{{ stat.quiz.title|escapejs }} - Answer Sheet';
        document.getElementById('answerSheetContent').innerHTML = html;
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('answerSheetModal'));
        modal.show();
    }
    {% endfor %}
</script>
{% endblock %}
