{% extends 'teachers/base_teacher.html' %}

{% block title %}Quiz Analytics{% endblock %}

{% block teacher_content %}
<style>
    .correct-answer { 
        background-color: #d4edda; 
        padding: 10px; 
        border-radius: 5px; 
        border-left: 4px solid #28a745; 
    }
    .question { 
        margin-bottom: 30px; 
        page-break-inside: avoid; 
    }
    .violation-section {
        transition: all 0.3s ease;
    }
    .violation-section:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
        transform: translateY(-2px);
    }
    .snapshot-thumb img {
        transition: transform 0.3s ease;
    }
    .snapshot-thumb:hover img {
        transform: scale(1.05);
    }
    @media print { 
        .no-print { display: none; }
        body { padding: 10px; }
    }
</style>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">Quiz Analytics Dashboard</h2>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-primary active" onclick="showTab('overview')">
                <i class="bi bi-graph-up"></i> Overview
            </button>
            <button type="button" class="btn btn-outline-primary" onclick="showTab('details')">
                <i class="bi bi-list-check"></i> Quiz Details
            </button>
            <button type="button" class="btn btn-outline-primary" onclick="showTab('students')">
                <i class="bi bi-people"></i> Student Performance
            </button>
            <button type="button" class="btn btn-outline-primary" onclick="showTab('proctoring')">
                <i class="bi bi-camera-video"></i> Proctoring Reports
            </button>
        </div>
    </div>
    
    {% if quiz_stats %}
        <!-- Overview Tab -->
        <div id="overviewTab" class="analytics-tab">
            <div class="row mb-4">
                <div class="col-md-3 mb-3">
                    <div class="card text-center h-100" style="border-left: 4px solid #667eea;">
                        <div class="card-body">
                            <h2 style="color: #667eea;">{{ quiz_stats|length }}</h2>
                            <p class="text-muted mb-0">Total Quizzes</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card text-center h-100" style="border-left: 4px solid #764ba2;">
                        <div class="card-body">
                            <h2 style="color: #764ba2;">{{ total_attempts }}</h2>
                            <p class="text-muted mb-0">Total Attempts</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card text-center h-100" style="border-left: 4px solid #28a745;">
                        <div class="card-body">
                            <h2 style="color: #28a745;">{{ unique_students }}</h2>
                            <p class="text-muted mb-0">Active Students</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card text-center h-100" style="border-left: 4px solid #ffc107;">
                        <div class="card-body">
                            <h2 style="color: #ffc107;">{{ overall_avg }}%</h2>
                            <p class="text-muted mb-0">Average Score</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                {% for stat in quiz_stats %}
                    <div class="col-md-4 mb-3">
                        <div class="card h-100" style="border-left: 3px solid #667eea;">
                            <div class="card-body">
                                <h6 class="card-title text-truncate" title="{{ stat.quiz.title }}">{{ stat.quiz.title }}</h6>
                                <p class="text-muted small mb-2">{{ stat.quiz.subject.name }}</p>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="badge bg-primary">{{ stat.total_attempts }} attempts</span>
                                    <span class="badge bg-success">{{ stat.avg_percentage }}%</span>
                                </div>
                                <div class="progress mb-3" style="height: 8px;">
                                    <div class="progress-bar" style="width: {{ stat.avg_percentage }}%; background-color: #667eea;"></div>
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-info flex-fill" onclick="copyQuizContent{{ stat.quiz.id }}()" title="Copy Questions & Answers">
                                        <i class="bi bi-clipboard"></i> Copy Q&A
                                    </button>
                                    <button class="btn btn-sm btn-outline-success flex-fill" onclick="viewAnswerSheet{{ stat.quiz.id }}()" title="View Answer Sheet">
                                        <i class="bi bi-eye"></i> View Answers
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Quiz Details Tab -->
        <div id="detailsTab" class="analytics-tab" style="display: none;">
            {% for stat in quiz_stats %}
                <div class="card shadow-lg mb-4">
                    <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-0">{{ stat.quiz.title }}</h5>
                                <small>{{ stat.quiz.subject.name }}</small>
                                {% if stat.quiz.deadline %}
                                    <div class="mt-1"><i class="bi bi-calendar-event"></i> Deadline: {{ stat.quiz.deadline|date:"M d, Y g:i A" }}</div>
                                {% endif %}
                            </div>
                            <div class="d-flex gap-2 align-items-center">
                                {% if stat.quiz.is_active %}
                                    <span class="badge bg-success fs-6"><i class="bi bi-circle-fill"></i> Active</span>
                                {% else %}
                                    <span class="badge bg-secondary fs-6"><i class="bi bi-circle-fill"></i> Inactive</span>
                                {% endif %}
                                <div class="btn-group">
                                    <a href="{% url 'quiz_detail' stat.quiz.id %}" class="btn btn-light btn-sm" title="Edit Quiz">
                                        <i class="bi bi-pencil-square"></i> Edit
                                    </a>
                                    <button type="button" class="btn btn-sm toggle-quiz-btn {% if stat.quiz.is_active %}btn-warning{% else %}btn-success{% endif %}" 
                                            data-quiz-id="{{ stat.quiz.id }}" data-is-active="{{ stat.quiz.is_active }}" title="{% if stat.quiz.is_active %}Deactivate{% else %}Activate{% endif %} Quiz">
                                        <i class="bi {% if stat.quiz.is_active %}bi-pause-circle{% else %}bi-play-circle{% endif %}"></i>
                                        {% if stat.quiz.is_active %}Deactivate{% else %}Activate{% endif %}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="text-center p-3" style="background-color: #f8f9fa; border-radius: 10px;">
                                    <h3 class="mb-0" style="color: #667eea;">{{ stat.total_attempts }}</h3>
                                    <small class="text-muted">Total Attempts</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center p-3" style="background-color: #f8f9fa; border-radius: 10px;">
                                    <h3 class="mb-0" style="color: #764ba2;">{{ stat.total_questions }}</h3>
                                    <small class="text-muted">Questions</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center p-3" style="background-color: #f8f9fa; border-radius: 10px;">
                                    <h3 class="mb-0" style="color: #28a745;">{{ stat.avg_score }}</h3>
                                    <small class="text-muted">Avg Score</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center p-3" style="background-color: #f8f9fa; border-radius: 10px;">
                                    <h3 class="mb-0" style="color: #ffc107;">{{ stat.quiz.duration }}</h3>
                                    <small class="text-muted">Minutes</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <h6>Performance Overview</h6>
                            <div class="progress" style="height: 30px;">
                                <div class="progress-bar" style="width: {{ stat.avg_percentage }}%; background-color: #667eea;" role="progressbar">
                                    <strong>{{ stat.avg_percentage }}% Average</strong>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Quiz Information</h6>
                                <ul class="list-unstyled">
                                    <li><i class="bi bi-file-pdf"></i> <strong>PDF:</strong> {{ stat.quiz.pdf_note.title }}</li>
                                    <li><i class="bi bi-calendar"></i> <strong>Created:</strong> {{ stat.quiz.created_at|date:"M d, Y" }}</li>
                                    <li><i class="bi bi-person"></i> <strong>Creator:</strong> {{ stat.quiz.created_by.username }}</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Statistics</h6>
                                <ul class="list-unstyled">
                                    <li><i class="bi bi-graph-up"></i> <strong>Highest Score:</strong> {{ stat.highest_score }}/{{ stat.total_questions }}</li>
                                    <li><i class="bi bi-graph-down"></i> <strong>Lowest Score:</strong> {{ stat.lowest_score }}/{{ stat.total_questions }}</li>
                                    <li><i class="bi bi-people"></i> <strong>Unique Students:</strong> {{ stat.unique_students }}</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
        
        <!-- Student Performance Tab -->
        <div id="studentsTab" class="analytics-tab" style="display: none;">
            <div class="row">
                {% for stat in quiz_stats %}
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card h-100 shadow-sm quiz-card" style="cursor: pointer; transition: all 0.3s;" 
                             data-bs-toggle="modal" data-bs-target="#studentModal{{ stat.quiz.id }}"
                             onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.4)';"
                             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='';">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="mb-0 flex-grow-1" style="color: #667eea;">
                                        <i class="bi bi-clipboard-check"></i> {{ stat.quiz.title|truncatewords:6 }}
                                    </h6>
                                    <i class="bi bi-eye" style="color: #667eea;"></i>
                                </div>
                                <p class="text-muted small mb-2">
                                    <i class="bi bi-book"></i> {{ stat.quiz.subject.name }}
                                </p>
                                <div class="d-flex gap-2 mb-2">
                                    <span class="badge bg-primary">{{ stat.total_attempts }} attempts</span>
                                    <span class="badge bg-success">{{ stat.avg_percentage }}% avg</span>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar" style="width: {{ stat.avg_percentage }}%; background-color: #667eea;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Student Performance Modal -->
                    <div class="modal fade" id="studentModal{{ stat.quiz.id }}" tabindex="-1" aria-labelledby="studentModalLabel{{ stat.quiz.id }}" aria-hidden="true">
                        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
                            <div class="modal-content">
                                <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                    <div>
                                        <h5 class="modal-title" id="studentModalLabel{{ stat.quiz.id }}">
                                            <i class="bi bi-people"></i> Student Performance
                                        </h5>
                                        <small>{{ stat.quiz.title }}</small>
                                    </div>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body p-0">
                                    {% with completed_attempts=stat.quiz.attempts.all %}
                                        {% if completed_attempts %}
                                            <div class="table-responsive">
                                                <table class="table table-hover mb-0 align-middle">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th class="ps-3">Student</th>
                                                            <th class="text-center">Score</th>
                                                            <th>Percentage</th>
                                                            <th class="text-center">Grade</th>
                                                            <th class="text-center">Completed</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for attempt in completed_attempts %}
                                                            {% if attempt.completed_at and attempt.score is not None and stat.total_questions > 0 %}
                                                                <tr>
                                                                    <td class="ps-3">
                                                                        <div class="d-flex align-items-center">
                                                                            <div class="rounded-circle text-white d-flex align-items-center justify-content-center me-2" 
                                                                                 style="width: 32px; height: 32px; font-weight: bold; font-size: 14px;
                                                                                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                                                                {{ attempt.student.username|slice:":1"|upper }}
                                                                            </div>
                                                                            <strong>{{ attempt.student.username }}</strong>
                                                                        </div>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <span class="badge bg-light text-dark px-2 py-1">{{ attempt.score }}/{{ stat.total_questions }}</span>
                                                                    </td>
                                                                    <td>
                                                                        <script>
                                                                            var percentageValue{{ attempt.id }} = Math.round(({{ attempt.score }} / {{ stat.total_questions }}) * 100);
                                                                            document.write('<div class="progress" style="height: 20px; min-width: 100px;">');
                                                                            var bgColor = percentageValue{{ attempt.id }} >= 90 ? '#28a745' : 
                                                                                        percentageValue{{ attempt.id }} >= 75 ? '#667eea' : 
                                                                                        percentageValue{{ attempt.id }} >= 50 ? '#ffc107' : 
                                                                                        percentageValue{{ attempt.id }} >= 35 ? '#17a2b8' : '#dc3545';
                                                                            document.write('<div class="progress-bar fw-bold" style="width: ' + percentageValue{{ attempt.id }} + '%; background-color: ' + bgColor + ';" role="progressbar">');
                                                                            document.write('<small>' + percentageValue{{ attempt.id }} + '%</small>');
                                                                            document.write('</div></div>');
                                                                        </script>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <script>
                                                                            var grade{{ attempt.id }} = percentageValue{{ attempt.id }} >= 90 ? 'A' : 
                                                                                                        percentageValue{{ attempt.id }} >= 75 ? 'B' : 
                                                                                                        percentageValue{{ attempt.id }} >= 50 ? 'C' : 
                                                                                                        percentageValue{{ attempt.id }} >= 35 ? 'D' : 'F';
                                                                            var badgeClass{{ attempt.id }} = percentageValue{{ attempt.id }} >= 90 ? 'bg-success' : 
                                                                                                            percentageValue{{ attempt.id }} >= 75 ? 'bg-primary' : 
                                                                                                            percentageValue{{ attempt.id }} >= 50 ? 'bg-warning text-dark' : 
                                                                                                            percentageValue{{ attempt.id }} >= 35 ? 'bg-info text-dark' : 'bg-danger';
                                                                            document.write('<span class="badge px-3 py-2 ' + badgeClass{{ attempt.id }} + '">' + grade{{ attempt.id }} + '</span>');
                                                                        </script>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <small class="text-muted">
                                                                            {{ attempt.completed_at|date:"M d, Y" }}<br>
                                                                            {{ attempt.completed_at|date:"g:i A" }}
                                                                        </small>
                                                                    </td>
                                                                </tr>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        {% else %}
                                            <div class="p-4 text-center text-muted">
                                                <i class="bi bi-info-circle fs-3"></i>
                                                <p class="mb-0 mt-2">No attempts yet for this quiz</p>
                                            </div>
                                        {% endif %}
                                    {% endwith %}
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            {% if not quiz_stats %}
                <div class="alert alert-info d-flex align-items-center">
                    <i class="bi bi-info-circle me-2 fs-4"></i>
                    <span>No quiz attempts yet</span>
                </div>
            {% endif %}
        </div>
        
        <!-- Proctoring Reports Tab -->
        <div id="proctoringTab" class="analytics-tab" style="display: none;">
            {% if proctoring_data %}
                <div class="row">
                    {% for item in proctoring_data %}
                        <div class="col-12 mb-5">
                            <div class="card shadow-lg border-0">
                                <div class="card-header text-white" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h4 class="mb-1"><i class="bi bi-clipboard-check"></i> {{ item.quiz.title }}</h4>
                                            <div>
                                                <span class="badge bg-white text-dark me-2">
                                                    <i class="bi bi-book"></i> {{ item.quiz.subject.name }}
                                                </span>
                                                <span class="badge bg-white text-dark">
                                                    <i class="bi bi-people"></i> {{ item.attempts_with_violations.count }} Student{{ item.attempts_with_violations.count|pluralize }}
                                                </span>
                                            </div>
                                        </div>
                                        <span class="badge bg-white text-danger fs-4 px-3 py-2">
                                            <i class="bi bi-exclamation-triangle-fill"></i> {{ item.total_violations }} Violation{{ item.total_violations|pluralize }}
                                        </span>
                                    </div>
                                </div>
                                <div class="card-body p-4">
                                    {% for attempt in item.attempts_with_violations %}
                                        <div class="violation-section mb-4 p-3 {% if attempt.completed_at %}bg-light{% else %}bg-warning bg-opacity-10{% endif %}" 
                                             style="border-left: 4px solid {% if attempt.completed_at %}#198754{% else %}#ffc107{% endif %}; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                            <div class="d-flex justify-content-between align-items-start mb-3">
                                                <div>
                                                    <h6 class="mb-1">
                                                        <i class="bi bi-person-circle"></i> {{ attempt.student.get_full_name|default:attempt.student.username }}
                                                    </h6>
                                                    <small class="text-muted">
                                                        {% if attempt.completed_at %}
                                                            <i class="bi bi-clock"></i> Completed: {{ attempt.completed_at|date:"M d, Y g:i A" }}
                                                            | <i class="bi bi-trophy"></i> Score: <strong>{{ attempt.score }}/{{ item.quiz.questions.count }}</strong>
                                                            ({{ attempt.score|floatformat:0 }}{% widthratio attempt.score item.quiz.questions.count 100 %}%)
                                                        {% else %}
                                                            <i class="bi bi-clock"></i> Started: {{ attempt.started_at|date:"M d, Y g:i A" }}
                                                        {% endif %}
                                                    </small>
                                                </div>
                                                <div class="text-end">
                                                    <span class="badge bg-danger me-1 px-2 py-1">
                                                        <i class="bi bi-camera"></i> {{ attempt.snapshots.count }} Snapshot{{ attempt.snapshots.count|pluralize }}
                                                    </span>
                                                    <span class="badge bg-info me-1 px-2 py-1">
                                                        <i class="bi bi-arrow-left-right"></i> {{ attempt.tab_switch_count }} Tab Switch{{ attempt.tab_switch_count|pluralize:"es" }}
                                                    </span>
                                                    <span class="badge bg-secondary px-2 py-1">
                                                        <i class="bi bi-fullscreen-exit"></i> {{ attempt.fullscreen_exit_count }} FS Exit{{ attempt.fullscreen_exit_count|pluralize }}
                                                    </span>
                                                </div>
                                            </div>
                                            
                                            {% if attempt.snapshots.all %}
                                                <div class="row g-3 mt-2">
                                                    {% for snapshot in attempt.snapshots.all %}
                                                        <div class="col-md-3">
                                                            <div class="snapshot-thumb position-relative">
                                                                <img src="{{ snapshot.image.url }}" class="img-fluid rounded shadow-sm" alt="Violation" style="width: 100%; height: 150px; object-fit: cover; cursor: pointer;" onclick="viewFullSnapshot('{{ snapshot.image.url }}', '{{ snapshot.violation_type }}', '{{ snapshot.timestamp|date:"M d, g:i A" }}')">
                                                                <span class="badge position-absolute top-0 start-0 m-2
                                                                    {% if snapshot.violation_type == 'no_person' %}bg-warning
                                                                    {% elif snapshot.violation_type == 'multiple_persons' %}bg-danger
                                                                    {% else %}bg-info
                                                                    {% endif %}">
                                                                    {% if snapshot.violation_type == 'no_person' %}
                                                                        <i class="bi bi-person-x"></i> No Person
                                                                    {% elif snapshot.violation_type == 'multiple_persons' %}
                                                                        <i class="bi bi-people-fill"></i> {{ snapshot.person_count }} Persons
                                                                    {% else %}
                                                                        <i class="bi bi-phone-fill"></i> Phone
                                                                    {% endif %}
                                                                </span>
                                                                <span class="badge bg-dark position-absolute bottom-0 end-0 m-2">
                                                                    <i class="bi bi-clock"></i> {{ snapshot.timestamp|date:"g:i A" }}
                                                                </span>
                                                            </div>
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-check-circle text-success" style="font-size: 5rem;"></i>
                    <h4 class="mt-3 text-muted">No Violations Detected</h4>
                    <p class="text-muted">All students followed quiz rules properly.</p>
                </div>
            {% endif %}
        </div>
    {% else %}
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> No quizzes created yet. Go to "Create Quiz" to generate your first quiz.
        </div>
    {% endif %}
</div>

<!-- Answer Sheet Modal -->
<div class="modal fade" id="answerSheetModal" tabindex="-1" aria-labelledby="answerSheetModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h5 class="modal-title" id="answerSheetModalLabel">Answer Sheet</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="answerSheetContent">
                <!-- Content will be dynamically loaded here -->
            </div>
            <div class="modal-footer no-print">
                <button type="button" class="btn btn-primary" onclick="window.print()">
                    <i class="bi bi-printer"></i> Print
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Snapshot Viewer Modal -->
<div class="modal fade" id="snapshotModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="bi bi-camera-video"></i> <span id="snapshotTitle">Violation Snapshot</span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="snapshotImage" src="" class="img-fluid rounded" alt="Snapshot">
                <p class="mt-3 text-muted" id="snapshotTime"></p>
            </div>
        </div>
    </div>
</div>

<script>
    function showTab(tabName) {
        // Save current tab to localStorage
        localStorage.setItem('quizAnalyticsActiveTab', tabName);
        
        // Hide all tabs
        document.querySelectorAll('.analytics-tab').forEach(tab => {
            tab.style.display = 'none';
        });
        
        // Remove active class from all buttons
        document.querySelectorAll('.btn-group .btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Show selected tab
        if (tabName === 'overview') {
            document.getElementById('overviewTab').style.display = 'block';
            document.querySelector('[onclick="showTab(\'overview\')"]').classList.add('active');
        } else if (tabName === 'details') {
            document.getElementById('detailsTab').style.display = 'block';
            document.querySelector('[onclick="showTab(\'details\')"]').classList.add('active');
        } else if (tabName === 'students') {
            document.getElementById('studentsTab').style.display = 'block';
            document.querySelector('[onclick="showTab(\'students\')"]').classList.add('active');
        } else if (tabName === 'proctoring') {
            document.getElementById('proctoringTab').style.display = 'block';
            document.querySelector('[onclick="showTab(\'proctoring\')"]').classList.add('active');
        }
    }
    
    // Restore active tab on page load
    document.addEventListener('DOMContentLoaded', function() {
        const savedTab = localStorage.getItem('quizAnalyticsActiveTab') || 'overview';
        showTab(savedTab);
    });

    // View full snapshot in modal
    function viewFullSnapshot(imageSrc, violationType, timestamp) {
        const modal = new bootstrap.Modal(document.getElementById('snapshotModal'));
        document.getElementById('snapshotImage').src = imageSrc;
        document.getElementById('snapshotTitle').textContent = violationType + ' - Violation Snapshot';
        document.getElementById('snapshotTime').textContent = 'Captured: ' + timestamp;
        modal.show();
    }

    // Toggle quiz active/inactive
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOMContentLoaded - setting up toggle buttons');
        const buttons = document.querySelectorAll('.toggle-quiz-btn');
        console.log('Found toggle buttons:', buttons.length);
        
        buttons.forEach(btn => {
            btn.addEventListener('click', function() {
                console.log('Toggle button clicked');
                const quizId = this.getAttribute('data-quiz-id');
                const isActive = this.getAttribute('data-is-active') === 'True';
                console.log('Quiz ID:', quizId, 'Is Active:', isActive);
                
                if (typeof customConfirm === 'undefined') {
                    console.error('customConfirm is not defined!');
                    alert('Error: Custom confirm dialog not loaded');
                    return;
                }
                
                customConfirm(`Are you sure you want to ${isActive ? 'deactivate' : 'activate'} this quiz?`, function(result) {
                    console.log('Confirm result:', result);
                    if (result) {
                        fetch(`/teacher/quiz/${quizId}/toggle/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}'
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Save current tab before reload
                                const currentTab = localStorage.getItem('quizAnalyticsActiveTab') || 'details';
                                localStorage.setItem('quizAnalyticsActiveTab', currentTab);
                                location.reload();
                            } else {
                                alert(data.error || 'Failed to toggle quiz status');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('An error occurred while updating quiz status');
                        });
                    }
                });
            });
        });
    });

    // Generate Copy and View functions for each quiz
    {% for stat in quiz_stats %}
    // Copy Quiz Content for Quiz ID {{ stat.quiz.id }}
    function copyQuizContent{{ stat.quiz.id }}() {
        let text = '{{ stat.quiz.title|escapejs }}\\n';
        text += 'Subject: {{ stat.quiz.subject.name|escapejs }}\\n';
        text += 'Total Questions: {{ stat.total_questions }}\\n';
        text += 'Duration: {{ stat.quiz.duration }} minutes\\n';
        text += '\\n' + '='.repeat(60) + '\\n\\n';
        
        {% for question in stat.quiz.questions.all %}
        text += 'Question {{ forloop.counter }}:\\n';
        text += '{{ question.text|escapejs }}\\n\\n';
        {% if question.question_type == 'multiple_choice' %}
        {% for option in question.options %}
        text += '  {{ forloop.counter }}. {{ option|escapejs }}\\n';
        {% endfor %}
        text += '\\nCorrect Answer: Option {{ question.correct_answer|add:1 }}\\n';
        {% elif question.question_type == 'true_false' %}
        text += 'Correct Answer: {% if question.correct_answer == "0" %}True{% else %}False{% endif %}\\n';
        {% else %}
        text += 'Correct Answer: {{ question.correct_answer|escapejs }}\\n';
        {% endif %}
        text += '\\n' + '-'.repeat(60) + '\\n\\n';
        {% endfor %}
        
        navigator.clipboard.writeText(text).then(function() {
            alert('Quiz content copied to clipboard!');
        }, function(err) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                alert('Quiz content copied to clipboard!');
            } catch (e) {
                alert('Failed to copy. Please try again.');
            }
            document.body.removeChild(textarea);
        });
    }

    // View Answer Sheet for Quiz ID {{ stat.quiz.id }}
    function viewAnswerSheet{{ stat.quiz.id }}() {
        let html = `
            <div class="mb-3">
                <strong>Subject:</strong> {{ stat.quiz.subject.name|escapejs }}<br>
                <strong>Total Questions:</strong> {{ stat.total_questions }}<br>
                <strong>Duration:</strong> {{ stat.quiz.duration }} minutes
            </div>
            <hr>
        `;
        
        {% for question in stat.quiz.questions.all %}
        html += `
            <div class="question mb-4">
                <h5 class="text-primary">Question {{ forloop.counter }}</h5>
                <p><strong>{{ question.text|escapejs }}</strong></p>
                {% if question.question_type == 'multiple_choice' %}
                <div class="options mb-2">
                    {% for option in question.options %}
                    <div class="{% if forloop.counter0|add:0 == question.correct_answer|add:0 %}correct-answer{% endif %} mb-1 p-2">
                        {{ forloop.counter }}. {{ option|escapejs }}
                        {% if forloop.counter0|add:0 == question.correct_answer|add:0 %}<strong> âœ“ (Correct Answer)</strong>{% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% elif question.question_type == 'true_false' %}
                <div class="correct-answer">
                    <strong>Correct Answer:</strong> {% if question.correct_answer == '0' %}True{% else %}False{% endif %}
                </div>
                {% else %}
                <div class="correct-answer">
                    <strong>Correct Answer:</strong> {{ question.correct_answer|escapejs }}
                </div>
                {% endif %}
            </div>
        `;
        {% endfor %}
        
        // Update modal content
        document.getElementById('answerSheetModalLabel').textContent = '{{ stat.quiz.title|escapejs }} - Answer Sheet';
        document.getElementById('answerSheetContent').innerHTML = html;
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('answerSheetModal'));
        modal.show();
    }
    {% endfor %}
</script>
{% endblock %}
