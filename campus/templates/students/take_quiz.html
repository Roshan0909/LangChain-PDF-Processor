{% extends 'students/base_student.html' %}

{% block title %}{{ quiz.title }} - Take Quiz{% endblock %}

{% block student_content %}
<style>
    /* Hide sidebar and navbar in fullscreen */
    :fullscreen .sidebar,
    :fullscreen .navbar,
    :-webkit-full-screen .sidebar,
    :-webkit-full-screen .navbar,
    :-moz-full-screen .sidebar,
    :-moz-full-screen .navbar,
    :-ms-fullscreen .sidebar,
    :-ms-fullscreen .navbar {
        display: none !important;
    }
    
    /* Adjust main content in fullscreen */
    :fullscreen body,
    :-webkit-full-screen body,
    :-moz-full-screen body,
    :-ms-fullscreen body {
        margin: 0 !important;
        padding: 20px !important;
    }
    
    :fullscreen .quiz-container,
    :-webkit-full-screen .quiz-container,
    :-moz-full-screen .quiz-container,
    :-ms-fullscreen .quiz-container {
        max-width: 100% !important;
        margin: 0 auto !important;
        padding: 0 40px !important;
    }
    
    .quiz-container {
        max-width: 900px;
        margin: 0 auto;
    }
    .question-card {
        border-left: 4px solid #06B6D4;
    }
    .option-label {
        cursor: pointer;
        padding: 1rem;
        border: 2px solid #e2e8f0;
        border-radius: 0.5rem;
        transition: all 0.3s;
    }
    .option-label:hover {
        background-color: #f8fafc;
        border-color: #06B6D4;
    }
    .option-label input:checked + span {
        font-weight: bold;
    }
    .option-label input:checked {
        accent-color: #06B6D4;
    }
    .timer {
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 1000;
        background: white;
        border: 3px solid #06B6D4;
        padding: 1.25rem 1.5rem;
        border-radius: 0.75rem;
        box-shadow: 0 4px 12px rgba(6, 182, 212, 0.2);
        text-align: center;
        min-width: 150px;
    }
    
    /* Proctoring Monitor */
    #proctoringMonitor {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        background: white;
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        overflow: hidden;
        width: 280px;
    }
    
    .proctoring-header {
        background: linear-gradient(135deg, #1E293B 0%, #0F172A 100%);
        border-top: 3px solid #06B6D4;
        padding: 0.75rem 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .proctoring-status {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .status-dot {
        width: 10px;
        height: 10px;
        background: #51cf66;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% {
            opacity: 1;
            transform: scale(1);
        }
        50% {
            opacity: 0.7;
            transform: scale(1.1);
        }
    }
    
    .status-text {
        color: white;
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    .detection-info {
        color: white;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    #webcamFeed {
        width: 100%;
        height: auto;
        display: block;
    }
    
    #detectionStatus {
        display: inline-block;
    }
    
    /* Fullscreen adjustments for proctoring monitor */
    :fullscreen #proctoringMonitor,
    :-webkit-full-screen #proctoringMonitor,
    :-moz-full-screen #proctoringMonitor,
    :-ms-fullscreen #proctoringMonitor {
        position: fixed !important;
        bottom: 20px !important;
        right: 20px !important;
    }
    
    @media (max-width: 768px) {
        #proctoringMonitor {
            width: 220px;
            bottom: 10px;
            right: 10px;
        }
    }
    .timer h4 {
        color: #667eea !important;
        font-size: 2.2rem;
        font-weight: 800;
        margin: 0;
        letter-spacing: 2px;
    }
    .timer small {
        color: #764ba2;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        display: block;
        margin-top: 5px;
    }
    .progress-tracker {
        position: fixed;
        top: 220px;
        right: 20px;
        z-index: 1000;
        background: white;
        padding: 15px 20px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        min-width: 200px;
    }
    .progress-tracker h6 {
        color: #667eea;
        font-weight: 700;
        font-size: 0.9rem;
        margin-bottom: 15px;
        text-align: center;
    }
    .stat-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        font-size: 0.9rem;
    }
    .stat-label {
        color: #6c757d;
    }
    .stat-number {
        font-weight: 700;
        font-size: 1.1rem;
    }
    .quiz-container {
        margin-right: 240px;
    }
    
    /* Fullscreen adjustments */
    :fullscreen .timer,
    :-webkit-full-screen .timer,
    :-moz-full-screen .timer,
    :-ms-fullscreen .timer,
    :fullscreen .progress-tracker,
    :-webkit-full-screen .progress-tracker,
    :-moz-full-screen .progress-tracker,
    :-ms-fullscreen .progress-tracker {
        position: fixed !important;
        right: 20px !important;
    }
    
    :fullscreen .quiz-container,
    :-webkit-full-screen .quiz-container,
    :-moz-full-screen .quiz-container,
    :-ms-fullscreen .quiz-container {
        margin-right: 240px !important;
    }
    
    @media (max-width: 1200px) {
        .quiz-container {
            margin-right: 0;
        }
        .timer, .progress-tracker {
            position: relative;
            top: 0;
            right: 0;
            margin-bottom: 20px;
        }
    }
    
    /* Custom Confirmation Modal Styles */
    .custom-confirm-modal .modal-content {
        border: none;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    .custom-confirm-modal .modal-header {
        border: none;
        padding: 30px 30px 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 20px 20px 0 0;
    }
    .custom-confirm-modal .modal-body {
        padding: 30px;
        text-align: center;
        font-size: 1.1rem;
    }
    .custom-confirm-modal .modal-footer {
        border: none;
        padding: 0 30px 30px;
        justify-content: center;
        gap: 15px;
    }
    .custom-confirm-modal .warning-icon {
        font-size: 4rem;
        color: #f39c12;
        margin-bottom: 15px;
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }
    .custom-confirm-modal .btn-confirm {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        padding: 12px 30px;
        border-radius: 10px;
        font-weight: 600;
        transition: transform 0.2s;
    }
    .custom-confirm-modal .btn-confirm:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    .custom-confirm-modal .btn-cancel {
        background: #6c757d;
        border: none;
        padding: 12px 30px;
        border-radius: 10px;
        font-weight: 600;
        transition: transform 0.2s;
    }
    .custom-confirm-modal .btn-cancel:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(108, 117, 125, 0.4);
    }
    
    /* Custom Alert Modal Styles */
    .custom-alert-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(5px);
        z-index: 10000;
        animation: fadeIn 0.3s ease;
    }
    
    .custom-alert-modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border-radius: 20px;
        padding: 0;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-width: 450px;
        width: 90%;
        z-index: 10001;
        animation: slideDown 0.4s ease;
        overflow: hidden;
    }
    
    .custom-alert-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 25px;
        text-align: center;
    }
    
    .custom-alert-icon {
        font-size: 60px;
        margin-bottom: 10px;
    }
    
    .custom-alert-header.warning .custom-alert-icon { color: #ffd700; }
    .custom-alert-header.error .custom-alert-icon { color: #ff6b6b; }
    .custom-alert-header.success .custom-alert-icon { color: #51cf66; }
    .custom-alert-header.info .custom-alert-icon { color: #74c0fc; }
    
    .custom-alert-title {
        font-size: 24px;
        font-weight: 700;
        color: white;
        margin: 0;
    }
    
    .custom-alert-body {
        padding: 30px;
        text-align: center;
    }
    
    .custom-alert-message {
        font-size: 16px;
        color: #4a5568;
        line-height: 1.6;
        margin-bottom: 25px;
    }
    
    .custom-alert-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 40px;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .custom-alert-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translate(-50%, -60%);
        }
        to {
            opacity: 1;
            transform: translate(-50%, -50%);
        }
    }
</style>

<div class="quiz-container" id="quizContainer">
    {% if already_attempted %}
        <div class="alert alert-warning">
            <h4><i class="bi bi-check-circle"></i> You've already completed this quiz!</h4>
            <p>Your score: {{ already_attempted.score }}/{{ quiz.questions.count }}</p>
            <a href="{% url 'quiz' %}" class="btn btn-primary">Back to Quizzes</a>
        </div>
    {% else %}
        <!-- Timer -->
        <div class="timer">
            <h4 id="timer">{{ quiz.duration }}:00</h4>
            <small>Time Remaining</small>
        </div>
        
        <!-- Progress Tracker -->
        <div class="progress-tracker">
            <h6><i class="bi bi-list-check"></i> Progress</h6>
            
            <div class="stat-item">
                <span class="stat-label"><i class="bi bi-check-circle-fill text-success"></i> Attempted</span>
                <span class="stat-number text-success" id="attemptedCount">0</span>
            </div>
            
            <div class="stat-item">
                <span class="stat-label"><i class="bi bi-circle text-muted"></i> Remaining</span>
                <span class="stat-number text-muted" id="remainingCount">{{ quiz.questions.count }}</span>
            </div>
            
            <hr style="margin: 10px 0;">
            
            <div class="progress" style="height: 8px; border-radius: 5px;">
                <div id="progressBar" class="progress-bar" style="width: 0%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" role="progressbar"></div>
            </div>
            <div style="text-align: center; margin-top: 8px;">
                <small class="text-muted"><span id="progressPercent">0</span>% Complete</small>
            </div>
        </div>
        
        <!-- Quiz Header -->
        <div class="card shadow-lg mb-4">
            <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h3 class="mb-0">{{ quiz.title }}</h3>
                <p class="mb-0 mt-2">{{ quiz.subject.name }} | {{ quiz.questions.count }} Questions | {{ quiz.duration }} Minutes</p>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> <strong>Instructions:</strong>
                    <ul class="mb-0 mt-2">
                        <li>Select the best answer for each question</li>
                        <li>You can review and change your answers before submitting</li>
                        <li>Once submitted, you cannot retake this quiz</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Questions -->
        <form id="quizForm">
            {% csrf_token %}
            {% for question in questions %}
                <div class="card shadow-sm mb-4 question-card">
                    <div class="card-body">
                        <h5 class="mb-3">
                            <span class="badge" style="background-color: #667eea;">Q{{ forloop.counter }}</span>
                            {{ question.text }}
                        </h5>
                        
                        <div class="options">
                            {% for option in question.options %}
                                <label class="option-label d-block mb-2">
                                    <input type="radio" name="question_{{ question.id }}" value="{{ forloop.counter0 }}" required onchange="updateProgress()">
                                    <span class="ms-2">{{ forloop.counter|upper }}. {{ option }}</span>
                                </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endfor %}
            
            <!-- Submit Button -->
            <div class="card shadow-lg mb-4">
                <div class="card-body text-center">
                    <button type="submit" class="btn btn-lg" style="background-color: #667eea; color: white;" data-quiz-submit="true">
                        <i class="bi bi-check-circle"></i> Submit Quiz
                    </button>
                    <p class="text-muted mt-3 mb-0">Make sure you've answered all questions before submitting</p>
                </div>
            </div>
        </form>
        
        <!-- Visible Webcam Feed for Proctoring -->
        <div id="proctoringMonitor" style="display: none;">
            <div class="proctoring-header">
                <div class="proctoring-status">
                    <span class="status-dot"></span>
                    <span class="status-text">Monitoring Active</span>
                </div>
                <div class="detection-info">
                    <span id="detectionStatus">Analyzing...</span>
                </div>
            </div>
            <div style="padding: 8px 15px; background: #f8f9fa; border-top: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center;">
                <small class="text-muted"><i class="bi bi-exclamation-triangle"></i> Violations:</small>
                <span id="violationCounter" class="badge bg-danger">0/5</span>
            </div>
            <video id="webcamFeed" autoplay playsinline></video>
        </div>
        <canvas id="snapshotCanvas" style="display: none;"></canvas>
    {% endif %}
</div>

<!-- Result Modal -->
<!-- Confirmation Modal -->
<div class="modal fade custom-confirm-modal" id="confirmSubmitModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-question-circle-fill"></i> Confirm Submission</h5>
            </div>
            <div class="modal-body">
                <div class="warning-icon">‚ö†Ô∏è</div>
                <p class="mb-3"><strong>Are you sure you want to submit your quiz?</strong></p>
                <p class="text-muted mb-0">You cannot change your answers after submission.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-cancel text-white" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
                <button type="button" class="btn btn-confirm text-white" id="confirmSubmitBtn">
                    <i class="bi bi-check-circle"></i> Yes, Submit
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="resultModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h5 class="modal-title"><i class="bi bi-trophy"></i> Quiz Results</h5>
            </div>
            <div class="modal-body text-center">
                <div id="resultContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" onclick="window.print()">
                    <i class="bi bi-printer"></i> Print Report
                </button>
                <a href="{% url 'quiz' %}" class="btn" style="background-color: #667eea; color: white;">Back to Quizzes</a>
            </div>
        </div>
    </div>
</div>

<script>
    // Custom Alert Function
    function showAlert(message, type = 'warning', title = '') {
        // Remove ALL existing alerts and modals before showing new one
        const existingOverlays = document.querySelectorAll('.custom-alert-overlay');
        const existingModals = document.querySelectorAll('.custom-alert-modal');
        existingOverlays.forEach(el => el.remove());
        existingModals.forEach(el => el.remove());
        
        // Set default titles based on type
        const titles = {
            'warning': title || 'Warning',
            'error': title || 'Error',
            'success': title || 'Success',
            'info': title || 'Information'
        };
        
        const icons = {
            'warning': '‚ö†Ô∏è',
            'error': '‚ùå',
            'success': '‚úÖ',
            'info': '‚ÑπÔ∏è'
        };
        
        // Create overlay
        const overlay = document.createElement('div');
        overlay.className = 'custom-alert-overlay';
        overlay.style.display = 'block';
        overlay.setAttribute('data-alert-type', 'single');
        
        // Create modal
        const modal = document.createElement('div');
        modal.className = 'custom-alert-modal';
        modal.setAttribute('data-alert-type', 'single');
        modal.innerHTML = `
            <div class="custom-alert-header ${type}">
                <div class="custom-alert-icon">${icons[type]}</div>
                <h3 class="custom-alert-title">${titles[type]}</h3>
            </div>
            <div class="custom-alert-body">
                <p class="custom-alert-message">${message}</p>
                <button class="custom-alert-btn" onclick="closeCustomAlert()">OK</button>
            </div>
        `;
        
        document.body.appendChild(overlay);
        document.body.appendChild(modal);
        
        // Auto-close on overlay click
        overlay.addEventListener('click', closeCustomAlert);
    }
    
    function closeCustomAlert() {
        const overlays = document.querySelectorAll('.custom-alert-overlay[data-alert-type="single"]');
        const modals = document.querySelectorAll('.custom-alert-modal[data-alert-type="single"]');
        overlays.forEach(el => el.remove());
        modals.forEach(el => el.remove());
    }
    
    // Timer
    const duration = {{ quiz.duration }} * 60; // Convert to seconds
    let timeLeft = duration;
    const totalQuestions = {{ quiz.questions.count }};
    
    const timerElement = document.getElementById('timer');
    const quizForm = document.getElementById('quizForm');
    const attemptedCountElement = document.getElementById('attemptedCount');
    const remainingCountElement = document.getElementById('remainingCount');
    const progressBarElement = document.getElementById('progressBar');
    const progressPercentElement = document.getElementById('progressPercent');
    
    // Update progress tracker
    function updateProgress() {
        const allRadios = document.querySelectorAll('input[type="radio"]');
        const questionNames = new Set();
        
        // Get all unique question names
        allRadios.forEach(radio => {
            questionNames.add(radio.name);
        });
        
        // Count answered questions
        let answeredCount = 0;
        questionNames.forEach(name => {
            const radios = document.querySelectorAll(`input[name="${name}"]`);
            for (let radio of radios) {
                if (radio.checked) {
                    answeredCount++;
                    break;
                }
            }
        });
        
        const remainingCount = totalQuestions - answeredCount;
        const percentage = Math.round((answeredCount / totalQuestions) * 100);
        
        attemptedCountElement.textContent = answeredCount;
        remainingCountElement.textContent = remainingCount;
        progressBarElement.style.width = percentage + '%';
        progressPercentElement.textContent = percentage;
    }
    
    function updateTimer() {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        if (timeLeft <= 60) {
            timerElement.style.color = 'red';
        }
        
        if (timeLeft <= 0) {
            showAlert('Time is up! Your quiz will be submitted automatically.', 'warning', 'Time Up');
            setTimeout(() => {
                closeCustomAlert();
                submitQuiz();
            }, 2000);
        } else {
            timeLeft--;
        }
    }
    
    // Start timer
    {% if not already_attempted %}
        // Prevent navigation away from quiz
        let quizSubmitted = false;
        let isSubmitting = false;
        
        // Fullscreen proctoring
        let fullscreenEnabled = false;
        let fullscreenExitCount = 0;
        const MAX_FULLSCREEN_EXITS = 3;
        
        // Show fullscreen permission dialog on page load
        setTimeout(() => {
            showFullscreenPermissionDialog();
        }, 500);
        
        function showFullscreenPermissionDialog() {
            const overlay = document.createElement('div');
            overlay.className = 'custom-alert-overlay';
            overlay.style.display = 'block';
            
            const modal = document.createElement('div');
            modal.className = 'custom-alert-modal';
            modal.innerHTML = `
                <div class="custom-alert-header info">
                    <div class="custom-alert-icon">üîí</div>
                    <h3 class="custom-alert-title">Fullscreen Proctoring Required</h3>
                </div>
                <div class="custom-alert-body">
                    <p class="custom-alert-message">
                        <strong>This quiz requires fullscreen mode for proctoring.</strong><br><br>
                        ‚Ä¢ You must stay in fullscreen during the quiz<br>
                        ‚Ä¢ Exiting fullscreen will trigger warnings<br>
                        ‚Ä¢ After 3 exits, your quiz will be auto-submitted<br><br>
                        Click OK to enable fullscreen and start the quiz.
                    </p>
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button class="custom-alert-btn" onclick="enableFullscreen()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <i class="bi bi-arrows-fullscreen me-1"></i> Enable Fullscreen
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            document.body.appendChild(modal);
        }
        
        window.enableFullscreen = function() {
            // Remove permission dialog
            const overlays = document.querySelectorAll('.custom-alert-overlay');
            const modals = document.querySelectorAll('.custom-alert-modal');
            overlays.forEach(el => el.remove());
            modals.forEach(el => el.remove());
            
            // Hide sidebar and navbar
            hideSidebarAndNavbar();
            
            // Request fullscreen
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen().then(() => {
                    fullscreenEnabled = true;
                    startQuizTimer();
                }).catch(err => {
                    console.log('Fullscreen request failed:', err);
                    showAlert(
                        '‚ö†Ô∏è Please allow fullscreen mode to start the quiz.<br><br>Click the button again or press F11.',
                        'warning',
                        'Fullscreen Required'
                    );
                    setTimeout(() => {
                        showFullscreenPermissionDialog();
                    }, 2000);
                });
            } else if (elem.webkitRequestFullscreen) {
                elem.webkitRequestFullscreen();
                fullscreenEnabled = true;
                startQuizTimer();
            } else if (elem.msRequestFullscreen) {
                elem.msRequestFullscreen();
                fullscreenEnabled = true;
                startQuizTimer();
            }
        }
        
        function hideSidebarAndNavbar() {
            const sidebar = document.querySelector('.sidebar');
            const navbar = document.querySelector('.navbar');
            const mainContent = document.querySelector('.main-content');
            const container = document.querySelector('.container-fluid');
            const row = document.querySelector('.row');
            
            if (sidebar) sidebar.style.display = 'none';
            if (navbar) navbar.style.display = 'none';
            if (mainContent) {
                mainContent.style.marginLeft = '0';
                mainContent.style.padding = '20px';
            }
            if (container) container.classList.remove('container-fluid');
            if (row) row.classList.remove('row');
        }
        
        function showSidebarAndNavbar() {
            const sidebar = document.querySelector('.sidebar');
            const navbar = document.querySelector('.navbar');
            const mainContent = document.querySelector('.main-content');
            
            if (sidebar) sidebar.style.display = '';
            if (navbar) navbar.style.display = '';
            if (mainContent) {
                mainContent.style.marginLeft = '';
                mainContent.style.padding = '';
            }
        }
        
        function startQuizTimer() {
            // Start the timer only after fullscreen is enabled
            window.timerInterval = setInterval(updateTimer, 1000);
        }
        
        // Monitor fullscreen changes
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        document.addEventListener('msfullscreenchange', handleFullscreenChange);
        
        function handleFullscreenChange() {
            if (!document.fullscreenElement && fullscreenEnabled && !quizSubmitted && !isSubmitting) {
                // User exited fullscreen
                fullscreenExitCount++;
                
                if (fullscreenExitCount <= MAX_FULLSCREEN_EXITS) {
                    const warningsLeft = MAX_FULLSCREEN_EXITS - fullscreenExitCount;
                    
                    if (warningsLeft > 0) {
                        showAlert(
                            `‚ö†Ô∏è <strong>Warning ${fullscreenExitCount}/${MAX_FULLSCREEN_EXITS}: You exited fullscreen!</strong><br><br>` +
                            `${warningsLeft} warning${warningsLeft !== 1 ? 's' : ''} remaining before auto-submission.<br><br>` +
                            `Re-entering fullscreen automatically...`,
                            'warning',
                            'üîí Fullscreen Exit Detected'
                        );
                    } else {
                        showAlert(
                            'üö® <strong>FINAL WARNING!</strong><br><br>' +
                            'This is your last warning. One more fullscreen exit will AUTO-SUBMIT your quiz!<br><br>' +
                            'Re-entering fullscreen automatically...',
                            'error',
                            '‚ö†Ô∏è Last Fullscreen Warning'
                        );
                    }
                    
                    // Re-enter fullscreen after warning
                    setTimeout(() => {
                        hideSidebarAndNavbar(); // Hide again before re-entering
                        const elem = document.documentElement;
                        if (elem.requestFullscreen) {
                            elem.requestFullscreen().catch(err => console.log('Fullscreen re-entry failed:', err));
                        } else if (elem.webkitRequestFullscreen) {
                            elem.webkitRequestFullscreen();
                        } else if (elem.msRequestFullscreen) {
                            elem.msRequestFullscreen();
                        }
                    }, 2000);
                } else {
                    // Exceeded fullscreen exits - auto submit
                    if (!quizSubmitted) {
                        showAlert(
                            '‚ùå <strong>Quiz Auto-Submitted!</strong><br><br>' +
                            'You exceeded the maximum allowed fullscreen exits (3).<br>' +
                            'Your quiz has been automatically submitted.',
                            'error',
                            'üö´ Auto-Submission'
                        );
                        setTimeout(async () => {
                            await submitQuiz();
                        }, 2000);
                    }
                }
            } else if (document.fullscreenElement && !quizSubmitted) {
                // Entered fullscreen - hide sidebar and navbar
                hideSidebarAndNavbar();
            }
        }
        
        // Intercept all navigation clicks (links and buttons) to show custom styled dialog
        document.addEventListener('click', function(e) {
            if (quizSubmitted || isSubmitting) return;
            
            // Check if clicked element or its parent is a link or button that navigates away
            let target = e.target;
            while (target && target !== document) {
                // Check for links
                if (target.tagName === 'A' && target.href && !target.href.includes('#') && !target.hasAttribute('data-quiz-submit')) {
                    e.preventDefault();
                    showLeaveConfirmation(target.href);
                    return;
                }
                // Check for buttons that might navigate (in sidebar/nav)
                if ((target.tagName === 'BUTTON' || target.tagName === 'A') && 
                    (target.closest('.nav-link') || target.closest('.sidebar') || target.closest('.navbar')) &&
                    !target.hasAttribute('data-quiz-submit') &&
                    target.getAttribute('href') && 
                    !target.getAttribute('href').includes('#')) {
                    e.preventDefault();
                    showLeaveConfirmation(target.getAttribute('href'));
                    return;
                }
                target = target.parentElement;
            }
        }, true);
        
        // Show custom styled leave confirmation
        function showLeaveConfirmation(url) {
            const overlay = document.createElement('div');
            overlay.className = 'custom-alert-overlay';
            overlay.style.display = 'block';
            
            const modal = document.createElement('div');
            modal.className = 'custom-alert-modal';
            modal.innerHTML = `
                <div class="custom-alert-header warning">
                    <div class="custom-alert-icon">‚ö†Ô∏è</div>
                    <h3 class="custom-alert-title">Quiz In Progress</h3>
                </div>
                <div class="custom-alert-body">
                    <p class="custom-alert-message">
                        <strong>Are you sure you want to leave?</strong><br><br>
                        Your quiz is still in progress. Leaving now will <strong>AUTO-SUBMIT</strong> your quiz with your current answers.<br><br>
                        Time remaining: <span style="color: #667eea; font-weight: bold;">${document.getElementById('timer').textContent}</span>
                    </p>
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button class="custom-alert-btn" style="background: #6c757d;" onclick="closeLeaveConfirmation()">
                            <i class="bi bi-arrow-left me-1"></i> Stay on Quiz
                        </button>
                        <button class="custom-alert-btn" onclick="confirmLeave('${url}')">
                            <i class="bi bi-box-arrow-right me-1"></i> Leave & Submit
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            document.body.appendChild(modal);
            
            overlay.addEventListener('click', closeLeaveConfirmation);
        }
        
        window.closeLeaveConfirmation = function() {
            const overlay = document.querySelector('.custom-alert-overlay');
            const modal = document.querySelector('.custom-alert-modal');
            if (overlay) overlay.remove();
            if (modal) modal.remove();
        }
        
        window.confirmLeave = function(url) {
            closeLeaveConfirmation();
            
            // Submit quiz first before navigating
            submitQuizBeforeLeaving(url);
        }
        
        function submitQuizBeforeLeaving(targetUrl) {
            if (quizSubmitted) {
                window.location.href = targetUrl;
                return;
            }
            quizSubmitted = true;
            
            // Collect answers
            const formData = new FormData(quizForm);
            const answers = {};
            for (let [key, value] of formData.entries()) {
                if (key.startsWith('question_')) {
                    const questionId = key.replace('question_', '');
                    answers[questionId] = value;
                }
            }
            
            // Submit with fetch and wait for response before navigating
            fetch('{% url "submit_quiz" quiz.id %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ answers: answers }),
                keepalive: true // Ensures request completes even if page is closing
            })
            .then(response => response.json())
            .then(data => {
                // Navigate after successful submission
                window.location.href = targetUrl;
            })
            .catch(error => {
                console.error('Error submitting quiz:', error);
                // Navigate anyway after error
                window.location.href = targetUrl;
            });
        }
        
        // Auto-submit when they actually leave the page
        window.addEventListener('unload', function() {
            if (!quizSubmitted && !isSubmitting) {
                submitQuizOnLeave();
            }
        });
        
        // Also handle pagehide event (more reliable on mobile/modern browsers)
        window.addEventListener('pagehide', function() {
            if (!quizSubmitted && !isSubmitting) {
                submitQuizOnLeave();
            }
        });
        
        // Function to submit quiz when leaving page
        function submitQuizOnLeave() {
            if (quizSubmitted) return; // Prevent double submission
            quizSubmitted = true;
            
            // Collect answers
            const formData = new FormData(quizForm);
            const answers = {};
            for (let [key, value] of formData.entries()) {
                if (key.startsWith('question_')) {
                    const questionId = key.replace('question_', '');
                    answers[questionId] = value;
                }
            }
            
            // Prepare data with CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const submitData = new FormData();
            submitData.append('csrfmiddlewaretoken', csrfToken);
            submitData.append('answers', JSON.stringify(answers));
            
            // Use sendBeacon with FormData (includes CSRF)
            const beaconSent = navigator.sendBeacon('{% url "submit_quiz" quiz.id %}', submitData);
            
            // Fallback to synchronous XHR if sendBeacon not available or fails
            if (!beaconSent) {
                try {
                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', '{% url "submit_quiz" quiz.id %}', false); // Synchronous
                    xhr.setRequestHeader('X-CSRFToken', csrfToken);
                    xhr.setRequestHeader('Content-Type', 'application/json');
                    xhr.send(JSON.stringify({ answers: answers }));
                } catch(e) {
                    console.error('Failed to submit quiz:', e);
                }
            }
        }
        
        // Detect tab/window visibility changes with 3 warnings limit
        let isAlertShowing = false;
        let lastAlertTime = 0;
        let tabSwitchCount = 0;
        const MAX_WARNINGS = 3;
        
        document.addEventListener('visibilitychange', function() {
            const now = Date.now();
            // Prevent alerts if one was shown less than 2 seconds ago
            if (now - lastAlertTime < 2000) return;
            
            if (document.hidden && !quizSubmitted && !isAlertShowing) {
                tabSwitchCount++;
                
                // Show warning when they switch away
                isAlertShowing = true;
                lastAlertTime = now;
                closeCustomAlert(); // Close any existing alert first
                
                if (tabSwitchCount <= MAX_WARNINGS) {
                    const warningsLeft = MAX_WARNINGS - tabSwitchCount;
                    if (warningsLeft > 0) {
                        showAlert(
                            `‚ö†Ô∏è Warning ${tabSwitchCount}/${MAX_WARNINGS}: You switched to another tab!<br><br>` +
                            `<strong>${warningsLeft} warning${warningsLeft !== 1 ? 's' : ''} remaining</strong> before auto-submission.<br><br>` +
                            `Please stay on the quiz page!`,
                            'warning',
                            'üö® Tab Switch Detected'
                        );
                    } else {
                        // Last warning
                        showAlert(
                            'üö® <strong>FINAL WARNING!</strong><br><br>' +
                            'This is your last warning. One more tab switch will AUTO-SUBMIT your quiz!<br><br>' +
                            'Stay focused on your quiz to avoid losing progress.',
                            'error',
                            '‚ö†Ô∏è Last Warning'
                        );
                    }
                } else {
                    // Exceeded warnings - auto submit
                    if (!quizSubmitted) {
                        closeCustomAlert();
                        showAlert(
                            '‚ùå <strong>Quiz Auto-Submitted!</strong><br><br>' +
                            'You exceeded the maximum allowed tab switches (3).<br>' +
                            'Your quiz has been automatically submitted.',
                            'error',
                            'üö´ Auto-Submission'
                        );
                        setTimeout(async () => {
                            // Properly submit quiz using the main submit function
                            await submitQuiz();
                        }, 2000);
                    }
                    return; // Stop further processing
                }
                
                setTimeout(() => { isAlertShowing = false; }, 2000);
            } else if (!document.hidden && !quizSubmitted && !isAlertShowing && tabSwitchCount > 0 && tabSwitchCount <= MAX_WARNINGS) {
                // Show alert when they come back
                isAlertShowing = true;
                lastAlertTime = now;
                closeCustomAlert(); // Close any existing alert first
                const warningsLeft = MAX_WARNINGS - tabSwitchCount;
                showAlert(
                    `Welcome back! You have <strong>${warningsLeft} warning${warningsLeft !== 1 ? 's' : ''} remaining</strong>.<br><br>` +
                    'Please stay focused to avoid auto-submission.',
                    'info',
                    '‚úÖ Returned to Quiz'
                );
                setTimeout(() => { isAlertShowing = false; }, 2000);
            }
        });
        
        // Note: Focus detection removed to avoid false positives
        // Tab switching is handled by visibilitychange event above
        
        // Warn on page refresh/close (beforeunload)
        window.addEventListener('beforeunload', function(e) {
            if (!quizSubmitted && !isSubmitting) {
                e.preventDefault();
                e.returnValue = '';
                return '';
            }
        });
        
        // Intercept browser back button
        history.pushState(null, null, location.href);
        window.addEventListener('popstate', function(e) {
            if (!quizSubmitted && !isSubmitting) {
                history.pushState(null, null, location.href);
                showAlert(
                    '‚ö†Ô∏è <strong>Going Back?</strong><br><br>' +
                    'Your quiz is still in progress!<br>' +
                    'Please complete or submit your quiz first.',
                    'warning',
                    'Quiz In Progress'
                );
            }
        });
        
        // Prevent right-click during quiz
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            showAlert('Right-click is disabled during the quiz.', 'info', 'Action Disabled');
        });
        
        // Prevent common shortcuts (Ctrl+C, Ctrl+V, Ctrl+U, etc.)
        document.addEventListener('keydown', function(e) {
            // Prevent Ctrl+U (view source), Ctrl+Shift+I (dev tools), F12, Ctrl+Shift+J
            if (
                (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J' || e.key === 'C')) ||
                (e.ctrlKey && e.key === 'u') ||
                e.key === 'F12'
            ) {
                e.preventDefault();
                showAlert('This action is disabled during the quiz.', 'info', 'Action Disabled');
            }
        });
    {% endif %}
    
    // Handle form submission
    quizForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Mark that we're in submission process
        isSubmitting = true;
        quizSubmitted = true; // Mark as submitted immediately to prevent any warnings
        
        // Show custom confirmation modal
        const confirmModal = new bootstrap.Modal(document.getElementById('confirmSubmitModal'));
        confirmModal.show();
    });
    
    // Handle cancel button
    document.querySelector('[data-bs-dismiss="modal"]').addEventListener('click', function() {
        if (isSubmitting && !quizSubmitted) {
            // User cancelled submission, restore state
            isSubmitting = false;
            quizSubmitted = false;
        }
    });
    
    // Handle confirmation button click
    document.getElementById('confirmSubmitBtn').addEventListener('click', function() {
        isSubmitting = true;
        quizSubmitted = true; // Ensure it's marked as submitted
        const confirmModal = bootstrap.Modal.getInstance(document.getElementById('confirmSubmitModal'));
        confirmModal.hide();
        submitQuiz();
    });
    
    async function submitQuiz() {
        // Mark as submitted to prevent multiple submissions
        quizSubmitted = true;
        clearInterval(timerInterval);
        
        const formData = new FormData(quizForm);
        const answers = {};
        
        for (let [key, value] of formData.entries()) {
            if (key.startsWith('question_')) {
                const questionId = key.replace('question_', '');
                answers[questionId] = value;
            }
        }
        
        try {
            const response = await fetch('{% url "submit_quiz" quiz.id %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ answers: answers })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Ensure quiz is marked as submitted to prevent any navigation warnings
                quizSubmitted = true;
                
                const percentage = data.percentage;
                let grade = '';
                let emoji = '';
                let passStatus = '';
                
                if (percentage >= 90) {
                    grade = 'Excellent!';
                    emoji = 'üåü';
                    passStatus = '<span class="badge bg-success fs-5">PASS</span>';
                } else if (percentage >= 75) {
                    grade = 'Good Job!';
                    emoji = 'üëç';
                    passStatus = '<span class="badge bg-success fs-5">PASS</span>';
                } else if (percentage >= 50) {
                    grade = 'Not Bad!';
                    emoji = 'üìö';
                    passStatus = '<span class="badge bg-success fs-5">PASS</span>';
                } else if (percentage >= 35) {
                    grade = 'Keep Practicing!';
                    emoji = 'üí™';
                    passStatus = '<span class="badge bg-info fs-5">PASS</span>';
                } else {
                    grade = 'Need More Study!';
                    emoji = 'üìñ';
                    passStatus = '<span class="badge bg-danger fs-5">FAIL</span>';
                }
                
                // Build detailed report
                let reportHTML = `
                    <h1 style="font-size: 4rem;">${emoji}</h1>
                    <h3>${grade}</h3>
                    <h2 class="my-3">Score: ${data.score}/${data.total} ${passStatus}</h2>
                    <div class="progress mb-4" style="height: 30px;">
                        <div class="progress-bar" style="width: ${percentage}%; background-color: #667eea;" role="progressbar">
                            ${percentage}%
                        </div>
                    </div>
                    <button class="btn btn-outline-primary mb-3" onclick="toggleReport()">
                        <i class="bi bi-file-text"></i> View Detailed Report
                    </button>
                    <div id="detailedReport" style="display: none; max-height: 400px; overflow-y: auto; text-align: left;">
                `;
                
                // Add each question's result
                data.question_details.forEach((q, index) => {
                    const isCorrect = q.is_correct;
                    const icon = isCorrect ? '‚úì' : '‚úó';
                    const statusClass = isCorrect ? 'bg-success' : 'bg-danger';
                    const statusText = isCorrect ? 'Correct' : 'Wrong';
                    
                    reportHTML += `
                        <div class="card mb-3 border-${isCorrect ? 'success' : 'danger'}">
                            <div class="card-header ${statusClass} text-white">
                                <strong>${icon} Question ${index + 1}</strong>
                                <span class="badge bg-light text-dark float-end">${statusText}</span>
                            </div>
                            <div class="card-body">
                                <p class="mb-2"><strong>${q.text}</strong></p>
                    `;
                    
                    if (q.type === 'multiple_choice' && q.options) {
                        reportHTML += '<div class="ms-3">';
                        q.options.forEach((option, optIndex) => {
                            const studentSelected = q.student_answer == optIndex;
                            const isCorrectOption = q.correct_answer == optIndex;
                            let optionClass = '';
                            let icon = '';
                            
                            if (isCorrectOption) {
                                optionClass = 'text-success fw-bold';
                                icon = '‚úì ';
                            }
                            if (studentSelected && !isCorrect) {
                                optionClass = 'text-danger fw-bold';
                                icon = '‚úó ';
                            }
                            
                            reportHTML += `<p class="mb-1 ${optionClass}">${icon}${optIndex + 1}. ${option}</p>`;
                        });
                        reportHTML += '</div>';
                    } else if (q.type === 'true_false') {
                        const correctText = q.correct_answer == '0' ? 'True' : 'False';
                        const studentText = q.student_answer == '0' ? 'True' : 'False';
                        reportHTML += `
                            <p class="mb-1"><strong>Your Answer:</strong> <span class="text-${isCorrect ? 'success' : 'danger'}">${studentText}</span></p>
                            ${!isCorrect ? `<p class="mb-1"><strong>Correct Answer:</strong> <span class="text-success">${correctText}</span></p>` : ''}
                        `;
                    } else {
                        reportHTML += `
                            <p class="mb-1"><strong>Your Answer:</strong> <span class="text-${isCorrect ? 'success' : 'danger'}">${q.student_answer || 'Not answered'}</span></p>
                            ${!isCorrect ? `<p class="mb-1"><strong>Correct Answer:</strong> <span class="text-success">${q.correct_answer}</span></p>` : ''}
                        `;
                    }
                    
                    reportHTML += `
                            </div>
                        </div>
                    `;
                });
                
                reportHTML += '</div>';
                
                document.getElementById('resultContent').innerHTML = reportHTML;
                
                const modal = new bootstrap.Modal(document.getElementById('resultModal'));
                modal.show();
            } else {
                showAlert('Error: ' + data.error, 'error', 'Submission Error');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('Failed to submit quiz. Please try again.', 'error', 'Network Error');
        }
    }
    
    // Toggle detailed report
    function toggleReport() {
        const report = document.getElementById('detailedReport');
        const button = event.target;
        
        if (report.style.display === 'none') {
            report.style.display = 'block';
            button.innerHTML = '<i class="bi bi-chevron-up"></i> Hide Detailed Report';
        } else {
            report.style.display = 'none';
            button.innerHTML = '<i class="bi bi-file-text"></i> View Detailed Report';
        }
    }
    
    // ============ CAMERA PROCTORING WITH TENSORFLOW.JS ============
    {% if not already_attempted and attempt_id %}
    let cameraStream = null;
    let detectionModel = null;
    let isDetectionRunning = false;
    let lastViolationTime = 0;
    let cameraViolationCount = 0;
    const MAX_CAMERA_VIOLATIONS = 5;
    const VIOLATION_COOLDOWN = 10000; // 10 seconds between violation snapshots
    const DETECTION_INTERVAL = 3000; // Check every 3 seconds
    const ATTEMPT_ID = {{ attempt_id }};
    console.log('üÜî Quiz Attempt ID initialized:', ATTEMPT_ID);
    
    // Initialize camera proctoring
    async function initCameraProctoring() {
        console.log('üé¨ Initializing camera proctoring...');
        console.log('Attempt ID:', ATTEMPT_ID);
        try {
            // Request camera access
            const video = document.getElementById('webcamFeed');
            const monitorDiv = document.getElementById('proctoringMonitor');
            
            console.log('üìπ Requesting camera access...');
            cameraStream = await navigator.mediaDevices.getUserMedia({ 
                video: { width: 640, height: 480 } 
            });
            video.srcObject = cameraStream;
            
            // Show the proctoring monitor
            monitorDiv.style.display = 'block';
            
            console.log('‚úì Camera access granted');
            
            // Load TensorFlow.js COCO-SSD model
            console.log('ü§ñ Loading AI detection model...');
            await loadDetectionModel();
            
            // Start detection loop
            startDetection();
            
        } catch (error) {
            console.error('Camera proctoring error:', error);
            showAlert(
                'Camera access is required for proctoring. Please allow camera access to continue with the quiz.',
                'warning',
                'Camera Required'
            );
        }
    }
    
    async function loadDetectionModel() {
        try {
            console.log('Loading detection model...');
            // Load COCO-SSD model from CDN
            detectionModel = await cocoSsd.load();
            console.log('‚úì Detection model loaded');
        } catch (error) {
            console.error('Failed to load detection model:', error);
        }
    }
    
    async function startDetection() {
        if (!detectionModel || isDetectionRunning) return;
        
        isDetectionRunning = true;
        detectViolations();
    }
    
    async function detectViolations() {
        // Stop detection if max violations reached, quiz submitted, or detection disabled
        if (!isDetectionRunning || quizSubmitted || cameraViolationCount >= MAX_CAMERA_VIOLATIONS) {
            console.log('üõë Detection stopped:', { isDetectionRunning, quizSubmitted, cameraViolationCount });
            return;
        }
        
        try {
            const video = document.getElementById('webcamFeed');
            const statusElement = document.getElementById('detectionStatus');
            
            // Run detection
            const predictions = await detectionModel.detect(video);
            
            // Count persons and phones
            let personCount = 0;
            let phoneCount = 0;
            
            predictions.forEach(prediction => {
                if (prediction.class === 'person' && prediction.score > 0.5) {
                    personCount++;
                }
                if (prediction.class === 'cell phone' && prediction.score > 0.5) {
                    phoneCount++;
                }
            });
            
            // Update status display
            if (personCount === 0) {
                statusElement.textContent = '‚ö†Ô∏è No Person';
                statusElement.style.color = '#ff6b6b';
            } else if (personCount > 1) {
                statusElement.textContent = `‚ö†Ô∏è ${personCount} Persons`;
                statusElement.style.color = '#ff6b6b';
            } else if (phoneCount > 0) {
                statusElement.textContent = `‚ö†Ô∏è Phone Detected`;
                statusElement.style.color = '#ff6b6b';
            } else {
                statusElement.textContent = '‚úì All Good';
                statusElement.style.color = '#51cf66';
            }
            
            // Check for violations
            const now = Date.now();
            let violationType = null;
            
            if (personCount === 0) {
                violationType = 'no_person';
            } else if (personCount > 1) {
                violationType = 'multiple_persons';
            } else if (phoneCount > 0) {
                violationType = 'phone_detected';
            }
            
            // If violation detected and cooldown period passed
            if (violationType && (now - lastViolationTime > VIOLATION_COOLDOWN)) {
                lastViolationTime = now;
                cameraViolationCount++;
                
                console.log(`üö® VIOLATION DETECTED: ${violationType}, persons: ${personCount}, phones: ${phoneCount}`);
                console.log(`üì∏ Camera violation count: ${cameraViolationCount}/${MAX_CAMERA_VIOLATIONS}`);
                
                // Update violation counter display
                const violationCounter = document.getElementById('violationCounter');
                if (violationCounter) {
                    violationCounter.textContent = `${cameraViolationCount}/${MAX_CAMERA_VIOLATIONS}`;
                    if (cameraViolationCount >= MAX_CAMERA_VIOLATIONS - 1) {
                        violationCounter.classList.remove('bg-danger');
                        violationCounter.classList.add('bg-dark');
                    }
                }
                
                await captureAndSaveSnapshot(violationType, personCount, phoneCount);
                
                // Show warning based on violation count
                if (cameraViolationCount >= MAX_CAMERA_VIOLATIONS) {
                    // Stop detection immediately
                    isDetectionRunning = false;
                    
                    // Final violation - Auto submit quiz immediately
                    console.log('üõë MAX VIOLATIONS REACHED - AUTO SUBMITTING QUIZ');
                    
                    Swal.fire({
                        icon: 'error',
                        title: 'Quiz Auto-Submitted!',
                        html: `<strong>Violation ${cameraViolationCount}/${MAX_CAMERA_VIOLATIONS}</strong><br><br>` +
                              getViolationMessage(violationType, personCount, phoneCount) + '<br><br>' +
                              '<strong>Maximum camera violations reached!</strong><br>' +
                              'Your quiz has been automatically submitted.',
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        showConfirmButton: false,
                        timer: 3000,
                        timerProgressBar: true
                    });
                    
                    // Auto submit quiz immediately after short delay
                    setTimeout(() => {
                        submitQuiz();
                    }, 3000);
                    
                    return; // Exit detection loop
                } else if (cameraViolationCount === MAX_CAMERA_VIOLATIONS - 1) {
                    // Last warning before auto-submit
                    Swal.fire({
                        icon: 'warning',
                        title: 'FINAL WARNING!',
                        html: `<strong>Violation ${cameraViolationCount}/${MAX_CAMERA_VIOLATIONS}</strong><br><br>` +
                              getViolationMessage(violationType, personCount, phoneCount) + '<br><br>' +
                              '<strong style="color: #dc3545;">ONE MORE VIOLATION WILL AUTO-SUBMIT YOUR QUIZ!</strong>',
                        confirmButtonText: 'I Understand',
                        confirmButtonColor: '#f59e0b',
                        allowOutsideClick: false
                    });
                } else {
                    // Regular warning with violation count
                    Swal.fire({
                        icon: 'warning',
                        title: 'Proctoring Violation Detected',
                        html: `<strong>Violation ${cameraViolationCount}/${MAX_CAMERA_VIOLATIONS}</strong><br><br>` +
                              getViolationMessage(violationType, personCount, phoneCount) + '<br><br>' +
                              `<strong>${MAX_CAMERA_VIOLATIONS - cameraViolationCount} more violation${MAX_CAMERA_VIOLATIONS - cameraViolationCount > 1 ? 's' : ''} will auto-submit your quiz!</strong>`,
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#667eea',
                        timer: 6000,
                        timerProgressBar: true,
                        allowOutsideClick: false
                    });
                }
            }
            
        } catch (error) {
            console.error('Detection error:', error);
        }
        
        // Continue detection loop only if not at max violations
        if (isDetectionRunning && cameraViolationCount < MAX_CAMERA_VIOLATIONS && !quizSubmitted) {
            setTimeout(detectViolations, DETECTION_INTERVAL);
        } else {
            console.log('üõë Detection loop terminated');
        }
    }
    
    function getViolationMessage(violationType, personCount, phoneCount) {
        switch(violationType) {
            case 'no_person':
                return '‚ùå No person detected in front of camera.<br>Please ensure you are visible in the camera frame.';
            case 'multiple_persons':
                return `‚ùå Multiple persons detected (${personCount}).<br>Only you should be visible during the quiz.`;
            case 'phone_detected':
                return `‚ùå Mobile phone detected (${phoneCount}).<br>Put away all electronic devices immediately.`;
            default:
                return 'Proctoring violation detected.';
        }
    }
    
    async function captureAndSaveSnapshot(violationType, personCount, phoneCount) {
        try {
            const video = document.getElementById('webcamFeed');
            const canvas = document.getElementById('snapshotCanvas');
            const context = canvas.getContext('2d');
            
            // Set canvas size to match video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Draw video frame to canvas
            context.drawImage(video, 0, 0);
            
            // Convert canvas to base64 image
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            
            // Send to server
            const response = await fetch(`/student/quiz/proctoring/${ATTEMPT_ID}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    image: imageData,
                    violation_type: violationType,
                    person_count: personCount,
                    phone_count: phoneCount
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                console.log(`‚úì Violation snapshot saved: ${violationType}`, data);
            } else {
                console.error('‚ùå Failed to save snapshot:', data);
            }
            
        } catch (error) {
            console.error('‚ùå Failed to save snapshot - Exception:', error);
        }
    }
    
    // Start camera proctoring after fullscreen is enabled
    const originalStartQuizTimer = startQuizTimer;
    startQuizTimer = function() {
        originalStartQuizTimer();
        
        // Initialize camera proctoring
        setTimeout(() => {
            initCameraProctoring();
        }, 1000);
    }
    
    // Stop camera when quiz is submitted
    const originalSubmitQuiz = submitQuiz;
    submitQuiz = async function() {
        isDetectionRunning = false;
        
        // Stop camera stream
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
        }
        
        // Hide proctoring monitor
        const monitorDiv = document.getElementById('proctoringMonitor');
        if (monitorDiv) {
            monitorDiv.style.display = 'none';
        }
        
        await originalSubmitQuiz();
    }
    {% else %}
    console.log('‚ö†Ô∏è Camera proctoring NOT initialized');
    console.log('Already attempted:', {{ already_attempted|yesno:"true,false" }});
    console.log('Attempt ID:', '{{ attempt_id|default:"None" }}');
    {% endif %}
</script>

<!-- Load TensorFlow.js and COCO-SSD Model -->
{% if not already_attempted %}
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3"></script>
{% endif %}

{% endblock %}
