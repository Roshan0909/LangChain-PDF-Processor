{% extends 'students/base_student.html' %}
{% load static %}

{% block title %}{{ quiz.title }} - Practice Quiz{% endblock %}

{% block student_content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Quiz Header -->
            <div class="quiz-header-card">
                <div class="quiz-header-content">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h3><i class="bi bi-pencil-square me-2"></i>{{ quiz.title }}</h3>
                            <div class="mt-2">
                                <span class="badge-topic me-2">{{ quiz.topic }}</span>
                                {% if quiz.difficulty == 'easy' %}
                                    <span class="badge-difficulty badge-easy">Easy</span>
                                {% elif quiz.difficulty == 'medium' %}
                                    <span class="badge-difficulty badge-medium">Medium</span>
                                {% else %}
                                    <span class="badge-difficulty badge-hard">Hard</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="text-end">
                            <h4 class="mb-0 quiz-count">{{ questions|length }} Questions</h4>
                            <small class="quiz-mode">Practice Mode - No Timer</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progress -->
            <div class="progress-card">
                <div class="progress-content">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="progress-label"><i class="bi bi-list-check me-2"></i>Progress</span>
                        <span id="progressText" class="progress-count">0 / {{ questions|length }} answered</span>
                    </div>
                    <div class="progress-bar-container">
                        <div id="progressBar" class="progress-bar-fill" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Questions -->
            <form id="quizForm">
                {% for question in questions %}
                    <div class="card border-0 shadow-sm mb-4 question-card">
                        <div class="card-body p-4">
                            <div class="d-flex align-items-start mb-3">
                                <div class="badge bg-primary me-3" style="font-size: 1rem; padding: 0.5rem 0.75rem;">
                                    {{ forloop.counter }}
                                </div>
                                <h5 class="mb-0 flex-grow-1">{{ question.question }}</h5>
                            </div>

                            <div class="options-container">
                                {% for option in question.options %}
                                    <label class="option-box p-3 mb-2" for="q{{ forloop.parentloop.counter0 }}_opt{{ forloop.counter0 }}">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" 
                                                   name="question_{{ forloop.parentloop.counter0 }}" 
                                                   id="q{{ forloop.parentloop.counter0 }}_opt{{ forloop.counter0 }}" 
                                                   value="{{ forloop.counter0 }}"
                                                   onchange="updateProgress()">
                                            <span class="form-check-label w-100 ms-2">
                                                <strong>{{ forloop.counter|upper|slice:":1" }}.</strong> {{ option }}
                                            </span>
                                        </div>
                                    </label>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </form>

            <!-- Submit Button -->
            <div class="submit-card">
                <div class="submit-content text-center">
                    <button type="button" class="btn-submit" onclick="submitQuiz()">
                        <i class="bi bi-check-circle me-2"></i>Submit Answers
                    </button>
                    <div class="mt-2">
                        <small class="submit-hint">
                            <i class="bi bi-info-circle me-1"></i>
                            You can review and change your answers before submitting
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Results Modal -->
<div class="modal fade" id="resultsModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content" style="border: none; border-radius: 0.7rem; overflow: hidden;">
            <div class="modal-header" style="background: linear-gradient(135deg, #1E293B 0%, #0F172A 100%); border-top: 3px solid #06B6D4; color: white; padding: 1rem 1.3rem; border-bottom: none;">
                <h5 class="modal-title" style="font-weight: 700; font-size: 1.05rem;"><i class="bi bi-clipboard-check me-2"></i>Quiz Results</h5>
            </div>
            <div class="modal-body" id="resultsContent" style="background: #f8fafc; padding: 1.3rem;">
                <!-- Results will be loaded here -->
            </div>
            <div class="modal-footer" style="background: #f8fafc; border-top: 1px solid #e2e8f0; padding: 0.85rem 1.3rem; gap: 0.6rem;">
                <a href="{% url 'practice_quiz' %}" class="btn" style="background: #64748b; color: white; border: none; padding: 0.5rem 1.1rem; border-radius: 0.5rem; font-weight: 600; font-size: 0.85rem; text-decoration: none;">Back to Practice Quizzes</a>
                <button type="button" class="btn" onclick="window.location.reload()" style="background: linear-gradient(135deg, #06B6D4 0%, #0891b2 100%); color: white; border: none; padding: 0.5rem 1.1rem; border-radius: 0.5rem; font-weight: 700; box-shadow: 0 2px 8px rgba(6, 182, 212, 0.3); font-size: 0.85rem;">
                    <i class="bi bi-arrow-repeat me-1"></i>Retake Quiz
                </button>
            </div>
        </div>
    </div>
</div>

<script>
const totalQuestions = {{ questions|length }};

function updateProgress() {
    let answered = 0;
    for (let i = 0; i < totalQuestions; i++) {
        const radios = document.getElementsByName(`question_${i}`);
        for (let radio of radios) {
            if (radio.checked) {
                answered++;
                break;
            }
        }
    }
    
    const percentage = (answered / totalQuestions) * 100;
    document.getElementById('progressBar').style.width = percentage + '%';
    document.getElementById('progressText').textContent = `${answered} / ${totalQuestions} answered`;
}

function submitQuiz() {
    // Check if all questions are answered
    let answered = 0;
    for (let i = 0; i < totalQuestions; i++) {
        const radios = document.getElementsByName(`question_${i}`);
        for (let radio of radios) {
            if (radio.checked) {
                answered++;
                break;
            }
        }
    }
    
    if (answered < totalQuestions) {
        if (!confirm(`You have only answered ${answered} out of ${totalQuestions} questions.\n\nDo you want to submit anyway?`)) {
            return;
        }
    }
    
    // Collect answers
    const answers = {};
    for (let i = 0; i < totalQuestions; i++) {
        const radios = document.getElementsByName(`question_${i}`);
        for (let radio of radios) {
            if (radio.checked) {
                answers[i] = radio.value;
                break;
            }
        }
    }
    
    // Disable submit button
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Submitting...';
    
    // Submit to server
    fetch("{% url 'submit_practice_quiz' quiz.id %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ answers: answers })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayResults(data);
        } else {
            alert('Error: ' + (data.error || 'Failed to submit quiz'));
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error submitting quiz: ' + error.message);
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
}

function displayResults(data) {
    const percentage = data.percentage;
    let resultClass = 'success';
    let resultIcon = 'check-circle';
    let resultMessage = 'Excellent Work!';
    
    if (percentage < 50) {
        resultClass = 'danger';
        resultIcon = 'x-circle';
        resultMessage = 'Keep Practicing!';
    } else if (percentage < 70) {
        resultClass = 'warning';
        resultIcon = 'exclamation-circle';
        resultMessage = 'Good Effort!';
    }
    
    let html = `
        <div class="text-center mb-4">
            <i class="bi bi-${resultIcon} display-1 text-${resultClass}"></i>
            <h3 class="mt-3">${resultMessage}</h3>
            <h2 class="text-${resultClass}">Score: ${data.score}/${data.total} (${percentage}%)</h2>
        </div>
        
        <hr>
        
        <h5 class="mb-3"><i class="bi bi-list-check me-2"></i>Detailed Review</h5>
    `;
    
    data.results.forEach((result, index) => {
        const isCorrect = result.is_correct;
        const statusClass = isCorrect ? 'success' : 'danger';
        const statusIcon = isCorrect ? 'check-circle-fill' : 'x-circle-fill';
        
        html += `
            <div class="card mb-3 border-${statusClass}">
                <div class="card-header bg-${statusClass} bg-opacity-10">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-${statusIcon} text-${statusClass} me-2"></i>
                        <strong>Question ${index + 1}</strong>
                        <span class="badge bg-${statusClass} ms-auto">${isCorrect ? 'Correct' : 'Wrong'}</span>
                    </div>
                </div>
                <div class="card-body">
                    <p class="mb-3"><strong>${result.question}</strong></p>
                    
                    <div class="options-review">
                        ${result.options.map((option, optIdx) => {
                            let optionClass = '';
                            let optionIcon = '';
                            
                            if (optIdx === result.correct_answer) {
                                optionClass = 'border-success bg-success bg-opacity-10';
                                optionIcon = '<i class="bi bi-check-circle-fill text-success me-2"></i>';
                            } else if (optIdx === result.student_answer && !isCorrect) {
                                optionClass = 'border-danger bg-danger bg-opacity-10';
                                optionIcon = '<i class="bi bi-x-circle-fill text-danger me-2"></i>';
                            }
                            
                            return `
                                <div class="p-2 mb-2 rounded border ${optionClass}">
                                    ${optionIcon}${String.fromCharCode(65 + optIdx)}. ${option}
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    ${result.explanation ? `
                        <div class="alert alert-info mt-3 mb-0">
                            <strong><i class="bi bi-lightbulb me-2"></i>Explanation:</strong>
                            <p class="mb-0 mt-2">${result.explanation}</p>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    });
    
    document.getElementById('resultsContent').innerHTML = html;
    const modal = new bootstrap.Modal(document.getElementById('resultsModal'));
    modal.show();
}
</script>

<style>
    .quiz-header-card {
        background: linear-gradient(135deg, #1E293B 0%, #0F172A 100%);
        border-top: 3px solid #06B6D4;
        border-radius: 0.7rem;
        padding: 1.2rem 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 3px 10px rgba(6, 182, 212, 0.15);
    }
    
    .quiz-header-content h3 {
        color: white;
        font-weight: 700;
        font-size: 1.4rem;
        margin-bottom: 0.5rem;
    }
    
    .quiz-count {
        background: linear-gradient(135deg, #06B6D4 0%, #0891b2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-weight: 800;
    }
    
    .quiz-mode {
        color: #94a3b8;
    }
    
    .badge-topic {
        background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
        color: #3730a3;
        padding: 0.35rem 0.7rem;
        border-radius: 0.4rem;
        font-weight: 600;
        font-size: 0.8rem;
        display: inline-block;
    }
    
    .badge-difficulty {
        padding: 0.35rem 0.7rem;
        border-radius: 0.4rem;
        font-weight: 700;
        font-size: 0.8rem;
        display: inline-block;
    }
    
    .badge-easy {
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        color: #065f46;
    }
    
    .badge-medium {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        color: #92400e;
    }
    
    .badge-hard {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        color: #7f1d1d;
    }
    
    .progress-card {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 0.7rem;
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    }
    
    .progress-label {
        color: #1e293b;
        font-weight: 600;
        font-size: 0.9rem;
    }
    
    .progress-count {
        color: #64748b;
        font-weight: 600;
        font-size: 0.85rem;
    }
    
    .progress-bar-container {
        height: 10px;
        background: #e2e8f0;
        border-radius: 0.5rem;
        overflow: hidden;
    }
    
    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(135deg, #06B6D4 0%, #0891b2 100%);
        border-radius: 0.5rem;
        transition: width 0.3s ease;
    }
    
    .question-card {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 0.7rem;
        padding: 1.2rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
    }
    
    .question-card:hover {
        transform: translateX(3px);
        box-shadow: 0 4px 12px rgba(6, 182, 212, 0.15);
        border-color: #06B6D4;
    }
    
    .question-card .badge {
        background: linear-gradient(135deg, #06B6D4 0%, #0891b2 100%);
        color: white;
        font-weight: 700;
    }
    
    .option-box {
        border: 2px solid #e2e8f0;
        border-radius: 0.6rem;
        transition: all 0.3s;
        cursor: pointer;
        background: white;
        display: block;
        margin-bottom: 0.5rem;
    }
    
    .option-box:hover {
        border-color: #06B6D4;
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    }
    
    .option-box .form-check {
        margin-bottom: 0;
        display: flex;
        align-items: center;
    }
    
    .option-box .form-check-input {
        cursor: pointer;
        margin-top: 0;
    }
    
    .option-box .form-check-label {
        cursor: pointer;
        margin-bottom: 0;
    }
    
    .option-box input[type="radio"]:checked ~ .form-check-label {
        color: #0891b2;
        font-weight: 600;
    }
    
    .option-box:has(input[type="radio"]:checked) {
        border-color: #06B6D4;
        background: linear-gradient(135deg, #e0f2fe 0%, #cffafe 100%);
        box-shadow: 0 2px 8px rgba(6, 182, 212, 0.2);
    }
    
    .submit-card {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 0.7rem;
        padding: 1.5rem;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    }
    
    .btn-submit {
        background: linear-gradient(135deg, #06B6D4 0%, #0891b2 100%);
        color: white;
        border: none;
        padding: 0.75rem 2.5rem;
        border-radius: 0.6rem;
        font-weight: 700;
        font-size: 1rem;
        box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
        transition: all 0.3s ease;
    }
    
    .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(6, 182, 212, 0.4);
        color: white;
    }
    
    .submit-hint {
        color: #64748b;
        font-size: 0.85rem;
    }
    
    /* Results Modal Styling */
    .border-success {
        border-color: #10b981 !important;
    }
    
    .border-danger {
        border-color: #ef4444 !important;
    }
    
    .bg-success {
        background-color: #d1fae5 !important;
    }
    
    .bg-danger {
        background-color: #fee2e2 !important;
    }
    
    .text-success {
        color: #065f46 !important;
    }
    
    .text-danger {
        color: #7f1d1d !important;
    }
    
    .badge.bg-success {
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%) !important;
        color: #065f46 !important;
    }
    
    .badge.bg-danger {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%) !important;
        color: #7f1d1d !important;
    }
</style>
{% endblock %}
