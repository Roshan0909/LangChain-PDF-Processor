{% extends 'students/base_student.html' %}

{% block title %}{{ quiz.title }} - Take Quiz{% endblock %}

{% block student_content %}
<style>
    .quiz-container {
        max-width: 900px;
        margin: 0 auto;
    }
    .question-card {
        border-left: 4px solid #667eea;
    }
    .option-label {
        cursor: pointer;
        padding: 15px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        transition: all 0.3s;
    }
    .option-label:hover {
        background-color: #f8f9fa;
        border-color: #667eea;
    }
    .option-label input:checked + span {
        font-weight: bold;
    }
    .option-label input:checked {
        accent-color: #667eea;
    }
    .timer {
        position: fixed;
        top: 70px;
        right: 20px;
        z-index: 1000;
        background: white;
        padding: 15px 25px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    @media (max-width: 768px) {
        .timer {
            position: relative;
            top: 0;
            right: 0;
            margin-bottom: 20px;
        }
    }
</style>

<div class="quiz-container">
    {% if already_attempted %}
        <div class="alert alert-warning">
            <h4><i class="bi bi-check-circle"></i> You've already completed this quiz!</h4>
            <p>Your score: {{ already_attempted.score }}/{{ quiz.questions.count }}</p>
            <a href="{% url 'quiz' %}" class="btn btn-primary">Back to Quizzes</a>
        </div>
    {% else %}
        <!-- Timer -->
        <div class="timer">
            <div class="text-center">
                <h4 class="mb-0" id="timer" style="color: #667eea;">{{ quiz.duration }}:00</h4>
                <small class="text-muted">Time Remaining</small>
            </div>
        </div>
        
        <!-- Quiz Header -->
        <div class="card shadow-lg mb-4">
            <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h3 class="mb-0">{{ quiz.title }}</h3>
                <p class="mb-0 mt-2">{{ quiz.subject.name }} | {{ quiz.questions.count }} Questions | {{ quiz.duration }} Minutes</p>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> <strong>Instructions:</strong>
                    <ul class="mb-0 mt-2">
                        <li>Select the best answer for each question</li>
                        <li>You can review and change your answers before submitting</li>
                        <li>Once submitted, you cannot retake this quiz</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Questions -->
        <form id="quizForm">
            {% csrf_token %}
            {% for question in questions %}
                <div class="card shadow-sm mb-4 question-card">
                    <div class="card-body">
                        <h5 class="mb-3">
                            <span class="badge" style="background-color: #667eea;">Q{{ forloop.counter }}</span>
                            {{ question.text }}
                        </h5>
                        
                        <div class="options">
                            {% for option in question.options %}
                                <label class="option-label d-block mb-2">
                                    <input type="radio" name="question_{{ question.id }}" value="{{ forloop.counter0 }}" required>
                                    <span class="ms-2">{{ forloop.counter|upper }}. {{ option }}</span>
                                </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endfor %}
            
            <!-- Submit Button -->
            <div class="card shadow-lg mb-4">
                <div class="card-body text-center">
                    <button type="submit" class="btn btn-lg" style="background-color: #667eea; color: white;">
                        <i class="bi bi-check-circle"></i> Submit Quiz
                    </button>
                    <p class="text-muted mt-3 mb-0">Make sure you've answered all questions before submitting</p>
                </div>
            </div>
        </form>
    {% endif %}
</div>

<!-- Result Modal -->
<div class="modal fade" id="resultModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h5 class="modal-title"><i class="bi bi-trophy"></i> Quiz Results</h5>
            </div>
            <div class="modal-body text-center">
                <div id="resultContent"></div>
            </div>
            <div class="modal-footer">
                <a href="{% url 'quiz' %}" class="btn" style="background-color: #667eea; color: white;">Back to Quizzes</a>
            </div>
        </div>
    </div>
</div>

<script>
    // Timer
    const duration = {{ quiz.duration }} * 60; // Convert to seconds
    let timeLeft = duration;
    
    const timerElement = document.getElementById('timer');
    const quizForm = document.getElementById('quizForm');
    
    function updateTimer() {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        if (timeLeft <= 60) {
            timerElement.style.color = 'red';
        }
        
        if (timeLeft <= 0) {
            alert('Time is up! Submitting your quiz...');
            submitQuiz();
        } else {
            timeLeft--;
        }
    }
    
    // Start timer
    {% if not already_attempted %}
        const timerInterval = setInterval(updateTimer, 1000);
    {% endif %}
    
    // Handle form submission
    quizForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (confirm('Are you sure you want to submit? You cannot change your answers after submission.')) {
            submitQuiz();
        }
    });
    
    async function submitQuiz() {
        clearInterval(timerInterval);
        
        const formData = new FormData(quizForm);
        const answers = {};
        
        for (let [key, value] of formData.entries()) {
            if (key.startsWith('question_')) {
                const questionId = key.replace('question_', '');
                answers[questionId] = value;
            }
        }
        
        try {
            const response = await fetch('{% url "submit_quiz" quiz.id %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ answers: answers })
            });
            
            const data = await response.json();
            
            if (data.success) {
                const percentage = data.percentage;
                let grade = '';
                let emoji = '';
                
                if (percentage >= 90) {
                    grade = 'Excellent!';
                    emoji = 'ðŸŒŸ';
                } else if (percentage >= 75) {
                    grade = 'Good Job!';
                    emoji = 'ðŸ‘';
                } else if (percentage >= 60) {
                    grade = 'Not Bad!';
                    emoji = 'ðŸ“š';
                } else {
                    grade = 'Keep Trying!';
                    emoji = 'ðŸ’ª';
                }
                
                document.getElementById('resultContent').innerHTML = `
                    <h1 style="font-size: 4rem;">${emoji}</h1>
                    <h3>${grade}</h3>
                    <h2 class="my-4">Score: ${data.score}/${data.total}</h2>
                    <div class="progress" style="height: 30px;">
                        <div class="progress-bar" style="width: ${percentage}%; background-color: #667eea;" role="progressbar">
                            ${percentage}%
                        </div>
                    </div>
                `;
                
                const modal = new bootstrap.Modal(document.getElementById('resultModal'));
                modal.show();
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to submit quiz. Please try again.');
        }
    }
</script>
{% endblock %}
