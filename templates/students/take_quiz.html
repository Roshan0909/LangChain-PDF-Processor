{% extends 'students/base_student.html' %}

{% block title %}{{ quiz.title }} - Take Quiz{% endblock %}

{% block student_content %}
<style>
    .quiz-container {
        max-width: 900px;
        margin: 0 auto;
    }
    .question-card {
        border-left: 4px solid #667eea;
    }
    .option-label {
        cursor: pointer;
        padding: 15px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        transition: all 0.3s;
    }
    .option-label:hover {
        background-color: #f8f9fa;
        border-color: #667eea;
    }
    .option-label input:checked + span {
        font-weight: bold;
    }
    .option-label input:checked {
        accent-color: #667eea;
    }
    .timer {
        position: fixed;
        top: 70px;
        right: 20px;
        z-index: 1000;
        background: white;
        padding: 15px 25px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .progress-tracker {
        position: fixed;
        top: 260px;
        right: 20px;
        z-index: 1000;
        background: white;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        max-width: 180px;
    }
    .quiz-container {
        margin-right: 220px;
    }
    @media (max-width: 1200px) {
        .quiz-container {
            margin-right: 0;
        }
        .timer, .progress-tracker {
            position: relative;
            top: 0;
            right: 0;
            margin-bottom: 20px;
            max-width: 100%;
        }
    }
    
    /* Custom Confirmation Modal Styles */
    .custom-confirm-modal .modal-content {
        border: none;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    .custom-confirm-modal .modal-header {
        border: none;
        padding: 30px 30px 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 20px 20px 0 0;
    }
    .custom-confirm-modal .modal-body {
        padding: 30px;
        text-align: center;
        font-size: 1.1rem;
    }
    .custom-confirm-modal .modal-footer {
        border: none;
        padding: 0 30px 30px;
        justify-content: center;
        gap: 15px;
    }
    .custom-confirm-modal .warning-icon {
        font-size: 4rem;
        color: #f39c12;
        margin-bottom: 15px;
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }
    .custom-confirm-modal .btn-confirm {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        padding: 12px 30px;
        border-radius: 10px;
        font-weight: 600;
        transition: transform 0.2s;
    }
    .custom-confirm-modal .btn-confirm:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    .custom-confirm-modal .btn-cancel {
        background: #6c757d;
        border: none;
        padding: 12px 30px;
        border-radius: 10px;
        font-weight: 600;
        transition: transform 0.2s;
    }
    .custom-confirm-modal .btn-cancel:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(108, 117, 125, 0.4);
    }
</style>

<div class="quiz-container">
    {% if already_attempted %}
        <div class="alert alert-warning">
            <h4><i class="bi bi-check-circle"></i> You've already completed this quiz!</h4>
            <p>Your score: {{ already_attempted.score }}/{{ quiz.questions.count }}</p>
            <a href="{% url 'quiz' %}" class="btn btn-primary">Back to Quizzes</a>
        </div>
    {% else %}
        <!-- Timer -->
        <div class="timer">
            <div class="text-center">
                <h4 class="mb-0" id="timer" style="color: #667eea;">{{ quiz.duration }}:00</h4>
                <small class="text-muted">Time Remaining</small>
            </div>
        </div>
        
        <!-- Progress Tracker -->
        <div class="progress-tracker">
            <div class="text-center">
                <h6 class="mb-3" style="color: #667eea;">Progress</h6>
                <div class="mb-2">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="text-success"><i class="bi bi-check-circle-fill"></i> Attempted</span>
                        <strong id="attemptedCount" class="text-success">0</strong>
                    </div>
                </div>
                <div>
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="text-muted"><i class="bi bi-circle"></i> Remaining</span>
                        <strong id="remainingCount" class="text-muted">{{ quiz.questions.count }}</strong>
                    </div>
                </div>
                <hr>
                <div class="progress mt-2" style="height: 8px;">
                    <div id="progressBar" class="progress-bar" style="width: 0%; background-color: #667eea;" role="progressbar"></div>
                </div>
                <small class="text-muted d-block mt-2"><span id="progressPercent">0</span>% Complete</small>
            </div>
        </div>
        
        <!-- Quiz Header -->
        <div class="card shadow-lg mb-4">
            <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h3 class="mb-0">{{ quiz.title }}</h3>
                <p class="mb-0 mt-2">{{ quiz.subject.name }} | {{ quiz.questions.count }} Questions | {{ quiz.duration }} Minutes</p>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> <strong>Instructions:</strong>
                    <ul class="mb-0 mt-2">
                        <li>Select the best answer for each question</li>
                        <li>You can review and change your answers before submitting</li>
                        <li>Once submitted, you cannot retake this quiz</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Questions -->
        <form id="quizForm">
            {% csrf_token %}
            {% for question in questions %}
                <div class="card shadow-sm mb-4 question-card">
                    <div class="card-body">
                        <h5 class="mb-3">
                            <span class="badge" style="background-color: #667eea;">Q{{ forloop.counter }}</span>
                            {{ question.text }}
                        </h5>
                        
                        <div class="options">
                            {% for option in question.options %}
                                <label class="option-label d-block mb-2">
                                    <input type="radio" name="question_{{ question.id }}" value="{{ forloop.counter0 }}" required onchange="updateProgress()">
                                    <span class="ms-2">{{ forloop.counter|upper }}. {{ option }}</span>
                                </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endfor %}
            
            <!-- Submit Button -->
            <div class="card shadow-lg mb-4">
                <div class="card-body text-center">
                    <button type="submit" class="btn btn-lg" style="background-color: #667eea; color: white;">
                        <i class="bi bi-check-circle"></i> Submit Quiz
                    </button>
                    <p class="text-muted mt-3 mb-0">Make sure you've answered all questions before submitting</p>
                </div>
            </div>
        </form>
    {% endif %}
</div>

<!-- Result Modal -->
<!-- Confirmation Modal -->
<div class="modal fade custom-confirm-modal" id="confirmSubmitModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-question-circle-fill"></i> Confirm Submission</h5>
            </div>
            <div class="modal-body">
                <div class="warning-icon">‚ö†Ô∏è</div>
                <p class="mb-3"><strong>Are you sure you want to submit your quiz?</strong></p>
                <p class="text-muted mb-0">You cannot change your answers after submission.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-cancel text-white" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
                <button type="button" class="btn btn-confirm text-white" id="confirmSubmitBtn">
                    <i class="bi bi-check-circle"></i> Yes, Submit
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="resultModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h5 class="modal-title"><i class="bi bi-trophy"></i> Quiz Results</h5>
            </div>
            <div class="modal-body text-center">
                <div id="resultContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" onclick="window.print()">
                    <i class="bi bi-printer"></i> Print Report
                </button>
                <a href="{% url 'quiz' %}" class="btn" style="background-color: #667eea; color: white;">Back to Quizzes</a>
            </div>
        </div>
    </div>
</div>

<script>
    // Timer
    const duration = {{ quiz.duration }} * 60; // Convert to seconds
    let timeLeft = duration;
    const totalQuestions = {{ quiz.questions.count }};
    
    const timerElement = document.getElementById('timer');
    const quizForm = document.getElementById('quizForm');
    const attemptedCountElement = document.getElementById('attemptedCount');
    const remainingCountElement = document.getElementById('remainingCount');
    const progressBarElement = document.getElementById('progressBar');
    const progressPercentElement = document.getElementById('progressPercent');
    
    // Update progress tracker
    function updateProgress() {
        const allRadios = document.querySelectorAll('input[type="radio"]');
        const questionNames = new Set();
        
        // Get all unique question names
        allRadios.forEach(radio => {
            questionNames.add(radio.name);
        });
        
        // Count answered questions
        let answeredCount = 0;
        questionNames.forEach(name => {
            const radios = document.querySelectorAll(`input[name="${name}"]`);
            for (let radio of radios) {
                if (radio.checked) {
                    answeredCount++;
                    break;
                }
            }
        });
        
        const remainingCount = totalQuestions - answeredCount;
        const percentage = Math.round((answeredCount / totalQuestions) * 100);
        
        attemptedCountElement.textContent = answeredCount;
        remainingCountElement.textContent = remainingCount;
        progressBarElement.style.width = percentage + '%';
        progressPercentElement.textContent = percentage;
    }
    
    function updateTimer() {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        if (timeLeft <= 60) {
            timerElement.style.color = 'red';
        }
        
        if (timeLeft <= 0) {
            alert('Time is up! Submitting your quiz...');
            submitQuiz();
        } else {
            timeLeft--;
        }
    }
    
    // Start timer
    {% if not already_attempted %}
        const timerInterval = setInterval(updateTimer, 1000);
    {% endif %}
    
    // Handle form submission
    quizForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Show custom confirmation modal
        const confirmModal = new bootstrap.Modal(document.getElementById('confirmSubmitModal'));
        confirmModal.show();
    });
    
    // Handle confirmation button click
    document.getElementById('confirmSubmitBtn').addEventListener('click', function() {
        const confirmModal = bootstrap.Modal.getInstance(document.getElementById('confirmSubmitModal'));
        confirmModal.hide();
        submitQuiz();
    });
    
    async function submitQuiz() {
        clearInterval(timerInterval);
        
        const formData = new FormData(quizForm);
        const answers = {};
        
        for (let [key, value] of formData.entries()) {
            if (key.startsWith('question_')) {
                const questionId = key.replace('question_', '');
                answers[questionId] = value;
            }
        }
        
        try {
            const response = await fetch('{% url "submit_quiz" quiz.id %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ answers: answers })
            });
            
            const data = await response.json();
            
            if (data.success) {
                const percentage = data.percentage;
                let grade = '';
                let emoji = '';
                let passStatus = '';
                
                if (percentage >= 90) {
                    grade = 'Excellent!';
                    emoji = 'üåü';
                    passStatus = '<span class="badge bg-success fs-5">PASS</span>';
                } else if (percentage >= 75) {
                    grade = 'Good Job!';
                    emoji = 'üëç';
                    passStatus = '<span class="badge bg-success fs-5">PASS</span>';
                } else if (percentage >= 50) {
                    grade = 'Not Bad!';
                    emoji = 'üìö';
                    passStatus = '<span class="badge bg-success fs-5">PASS</span>';
                } else if (percentage >= 35) {
                    grade = 'Keep Practicing!';
                    emoji = 'üí™';
                    passStatus = '<span class="badge bg-info fs-5">PASS</span>';
                } else {
                    grade = 'Need More Study!';
                    emoji = 'üìñ';
                    passStatus = '<span class="badge bg-danger fs-5">FAIL</span>';
                }
                
                // Build detailed report
                let reportHTML = `
                    <h1 style="font-size: 4rem;">${emoji}</h1>
                    <h3>${grade}</h3>
                    <h2 class="my-3">Score: ${data.score}/${data.total} ${passStatus}</h2>
                    <div class="progress mb-4" style="height: 30px;">
                        <div class="progress-bar" style="width: ${percentage}%; background-color: #667eea;" role="progressbar">
                            ${percentage}%
                        </div>
                    </div>
                    <button class="btn btn-outline-primary mb-3" onclick="toggleReport()">
                        <i class="bi bi-file-text"></i> View Detailed Report
                    </button>
                    <div id="detailedReport" style="display: none; max-height: 400px; overflow-y: auto; text-align: left;">
                `;
                
                // Add each question's result
                data.question_details.forEach((q, index) => {
                    const isCorrect = q.is_correct;
                    const icon = isCorrect ? '‚úì' : '‚úó';
                    const statusClass = isCorrect ? 'bg-success' : 'bg-danger';
                    const statusText = isCorrect ? 'Correct' : 'Wrong';
                    
                    reportHTML += `
                        <div class="card mb-3 border-${isCorrect ? 'success' : 'danger'}">
                            <div class="card-header ${statusClass} text-white">
                                <strong>${icon} Question ${index + 1}</strong>
                                <span class="badge bg-light text-dark float-end">${statusText}</span>
                            </div>
                            <div class="card-body">
                                <p class="mb-2"><strong>${q.text}</strong></p>
                    `;
                    
                    if (q.type === 'multiple_choice' && q.options) {
                        reportHTML += '<div class="ms-3">';
                        q.options.forEach((option, optIndex) => {
                            const studentSelected = q.student_answer == optIndex;
                            const isCorrectOption = q.correct_answer == optIndex;
                            let optionClass = '';
                            let icon = '';
                            
                            if (isCorrectOption) {
                                optionClass = 'text-success fw-bold';
                                icon = '‚úì ';
                            }
                            if (studentSelected && !isCorrect) {
                                optionClass = 'text-danger fw-bold';
                                icon = '‚úó ';
                            }
                            
                            reportHTML += `<p class="mb-1 ${optionClass}">${icon}${optIndex + 1}. ${option}</p>`;
                        });
                        reportHTML += '</div>';
                    } else if (q.type === 'true_false') {
                        const correctText = q.correct_answer == '0' ? 'True' : 'False';
                        const studentText = q.student_answer == '0' ? 'True' : 'False';
                        reportHTML += `
                            <p class="mb-1"><strong>Your Answer:</strong> <span class="text-${isCorrect ? 'success' : 'danger'}">${studentText}</span></p>
                            ${!isCorrect ? `<p class="mb-1"><strong>Correct Answer:</strong> <span class="text-success">${correctText}</span></p>` : ''}
                        `;
                    } else {
                        reportHTML += `
                            <p class="mb-1"><strong>Your Answer:</strong> <span class="text-${isCorrect ? 'success' : 'danger'}">${q.student_answer || 'Not answered'}</span></p>
                            ${!isCorrect ? `<p class="mb-1"><strong>Correct Answer:</strong> <span class="text-success">${q.correct_answer}</span></p>` : ''}
                        `;
                    }
                    
                    reportHTML += `
                            </div>
                        </div>
                    `;
                });
                
                reportHTML += '</div>';
                
                document.getElementById('resultContent').innerHTML = reportHTML;
                
                const modal = new bootstrap.Modal(document.getElementById('resultModal'));
                modal.show();
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to submit quiz. Please try again.');
        }
    }
    
    // Toggle detailed report
    function toggleReport() {
        const report = document.getElementById('detailedReport');
        const button = event.target;
        
        if (report.style.display === 'none') {
            report.style.display = 'block';
            button.innerHTML = '<i class="bi bi-chevron-up"></i> Hide Detailed Report';
        } else {
            report.style.display = 'none';
            button.innerHTML = '<i class="bi bi-file-text"></i> View Detailed Report';
        }
    }
</script>
{% endblock %}
